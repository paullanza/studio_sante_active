<div class="container mt-4" data-controller="select-all">
  <h1 class="mb-4">Unconfirmed Sessions</h1>

  <%= form_with url: admin_confirm_sessions_path, method: :patch, local: true do %>
    <div class="mb-3 d-flex gap-2">
      <%= submit_tag "Confirm Selected", class: "btn btn-success" %>
    </div>

    <% if @sessions.any? %>
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead>
            <tr>
              <th class="text-center" style="width:36px;">
                <input type="checkbox" id="select-all"
                  data-action="select-all#toggleAll"
                  data-select-all-target="checkbox">
              </th>
              <th>Client</th>
              <th>Service</th>
              <th>Date</th>
              <th>Time</th>
              <th>Présent</th>
              <th>Note</th>
              <th>Créé par</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @sessions.each do |s| %>
              <tr
                data-controller="session-row"
                data-session-row-id-value="<%= s.id %>"
                data-session-row-update-url-value="<%= session_path(s) %>"
                data-session-row-delete-url-value="<%= session_path(s) %>">

                <!-- bulk confirm checkbox -->
                <td class="text-center">
                  <%= check_box_tag "session_ids[]", s.id, false,
                        class: "form-check-input",
                        data: { select_all_target: "checkboxItem" } %>
                </td>

                <!-- display row -->
                <td data-session-row-target="display" colspan="0">
                  <%= s.fliip_user&.full_name %>
                </td>
                <td data-session-row-target="display"><%= s.fliip_service&.service_name %></td>
                <td data-session-row-target="display" data-field="date"><%= s.date&.strftime("%Y-%m-%d") || "—" %></td>
                <td data-session-row-target="display" data-field="time"><%= s.time&.strftime("%H:%M") || "—" %></td>
                <td data-session-row-target="display" data-field="present"><%= s.present? ? "Oui" : "Non" %></td>
                <td data-session-row-target="display" data-field="note"><%= s.note.presence || "–" %></td>
                <td data-session-row-target="display"><%= s.user&.full_name || "–" %></td>
                <td data-session-row-target="display" class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-primary" data-action="session-row#edit">Edit</button>
                  <% if current_user.admin? || current_user.super_admin? %>
                    <button type="button" class="btn btn-sm btn-outline-danger" data-action="session-row#delete">Delete</button>
                  <% end %>
                </td>

                <!-- inline mini-form (hidden by default) -->
                <td class="d-none" colspan="7" data-session-row-target="form">
                  <div class="row g-2 align-items-center">
                    <div class="col-md-2">
                      <label class="form-label mb-0 small">Date</label>
                      <input type="date" class="form-control form-control-sm"
                            value="<%= s.date&.strftime('%Y-%m-%d') %>" data-session-row-target="date">
                    </div>

                    <div class="col-md-2">
                      <label class="form-label mb-0 small">Time</label>
                      <input type="time" class="form-control form-control-sm"
                            value="<%= s.time&.strftime('%H:%M') %>" data-session-row-target="time">
                    </div>

                    <div class="col-md-2">
                      <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox"
                              <%= "checked" if s.present? %> data-session-row-target="present" id="present_<%= s.id %>">
                        <label class="form-check-label small" for="present_<%= s.id %>">Présent</label>
                      </div>
                    </div>

                    <div class="col-md-3">
                      <label class="form-label mb-0 small">Note</label>
                      <input type="text" class="form-control form-control-sm"
                            value="<%= s.note.to_s %>" placeholder="Optional note…" data-session-row-target="note">
                    </div>

                    <div class="col-md-1">
                      <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox"
                              <%= "checked" if s.duration.to_f == 0.5 %>
                              data-session-row-target="halfHour" id="half_hour_<%= s.id %>">
                        <label class="form-check-label small" for="half_hour_<%= s.id %>">30 minutes</label>
                      </div>
                    </div>

                    <% if current_user.admin? || current_user.super_admin? %>
                      <div class="col-md-3">
                        <label class="form-label mb-0 small">Creator</label>
                        <select class="form-select form-select-sm" data-session-row-target="userId">
                          <% @staff.each do |u| %>
                            <option value="<%= u.id %>" <%= "selected" if u.id == s.user_id %>><%= u.full_name %></option>
                          <% end %>
                        </select>
                      </div>
                    <% end %>

                    <div class="col-md-2 text-end mt-4">
                      <button type="button" class="btn btn-sm btn-primary" data-action="session-row#save">Save</button>
                      <button type="button" class="btn btn-sm btn-outline-secondary" data-action="session-row#cancel">Cancel</button>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">No unconfirmed sessions found.</p>
    <% end %>
  <% end %>
</div>
