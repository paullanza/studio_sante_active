<div class="container my-4 booking-new" data-controller="client-search">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0 fw-bold">Réservation</h1>
  </div>

  <!-- One segmented-tabs controller drives both columns -->
  <div class="row g-4 align-items-stretch"
       data-controller="segmented-tabs"
       data-segmented-tabs-active-value="<%= @active_tab %>">

    <!-- LEFT: Form card with small slider tabs -->
    <div class="col-12 col-lg-3 d-flex">
      <div class="card shadow-sm stretch-card h-100 w-100 form-card">
        <!-- Scroll only inside the card body if needed; card itself does not exceed viewport -->
        <div class="card-body p-3 scrollable-card-body" style="max-height: calc(100vh - 180px); overflow:auto;">
          <!-- Slider tabs -->
          <div class="position-relative mb-3">
            <div class="d-flex border rounded-pill p-1 position-relative" style="--seg-height:32px;">
              <button type="button"
                      class="btn btn-sm flex-fill rounded-pill"
                      data-segmented-tabs-target="tab"
                      data-value="session"
                      data-action="segmented-tabs#activate"
                      style="height: var(--seg-height);">
                Séance
              </button>
              <button type="button"
                      class="btn btn-sm flex-fill rounded-pill"
                      data-segmented-tabs-target="tab"
                      data-value="consultation"
                      data-action="segmented-tabs#activate"
                      style="height: var(--seg-height);">
                Consultation
              </button>
              <div class="position-absolute bg-primary rounded-pill" data-segmented-tabs-target="slider"
                   style="top:4px; bottom:4px; left:4px; width:calc(50% - 4px); transition: all .18s ease;"></div>
            </div>
          </div>

          <!-- Pane: Session form -->
          <div data-segmented-tabs-target="pane" data-value="session" class="<%= @active_tab == 'session' ? '' : 'd-none' %>">
            <%= simple_form_for @session,
                url: sessions_path,
                html: {
                  class: "session-form",
                  data: {
                    controller: "session-form",
                    action: "turbo:frame-load@document->session-form#recheck"
                  }
                } do |f| %>

              <div class="row g-3 align-items-end mb-2">
                <div class="col-12">
                  <div class="d-flex justify-content-between align-items-center">
                    <label class="form-label mb-0" for="client_search_input">Client·e</label>
                    <%= link_to "Rafraîchir",
                          refresh_clients_path,
                          class: "small link-secondary text-decoration-underline",
                          data: { turbo_method: :post,
                                  turbo_confirm: "Ceci va rafraîchir la liste des clients depuis Fliip. Continuer?" } %>
                  </div>

                  <input
                    id="client_search_input"
                    type="text"
                    class="form-control form-control-sm"
                    placeholder="Rechercher un·e client·e par nom ou courriel…"
                    value="<%= @session.fliip_user&.full_name %>"
                    data-client-search-target="input"
                    data-action="
                      input->client-search#onInput
                      focus->client-search#onFocus
                      blur->client-search#onBlur
                      keydown.enter->client-search#preventSubmit
                    ">
                  <%= hidden_field_tag "session[fliip_user_id]", @session.fliip_user_id,
                        data: { client_search_target: "hiddenId", session_form_target: "userId" } %>
                  <div class="position-relative">
                    <div class="position-absolute start-0 end-0 mt-1" style="z-index:20;">
                      <%= turbo_frame_tag "client_suggestions" %>
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <% if @session.fliip_user_id.present? %>
                    <%= turbo_frame_tag "service_select",
                          src: service_select_sessions_path(
                            fliip_user_id: @session.fliip_user_id,
                            selected_id:   @session.fliip_service_id
                          ) %>
                  <% else %>
                    <%= turbo_frame_tag "service_select" do %>
                      <label class="form-label">Service</label>
                      <select class="form-select form-select-sm" disabled>
                        <option>Sélectionne un·e client·e d’abord</option>
                      </select>
                    <% end %>
                  <% end %>
                </div>

                <% if @staff.any? %>
                  <div class="col-12">
                    <label for="session_user_id" class="form-label">Créé par</label>
                    <select name="session[user_id]" id="session_user_id" class="form-select form-select-sm">
                      <option value="">Moi (<%= current_user.full_name %>)</option>
                      <% @staff.each do |u| %>
                        <option value="<%= u.id %>"><%= u.full_name %></option>
                      <% end %>
                    </select>
                  </div>
                <% end %>
              </div>

              <hr class="my-3">

              <div class="row g-3 align-items-end mb-2" data-controller="flatpickr">
                <div class="col-md-6">
                  <%= f.input :date, label: "Date", as: :string,
                        input_html: {
                          type: "text",
                          value: (@session.occurred_at&.to_date || Date.today),
                          class: "form-control form-control-sm",
                          data: { flatpickr_target: "date" }
                        } %>
                </div>

                <div class="col-md-6">
                  <div class="d-flex justify-content-between align-items-center">
                    <%= f.label :time, "Heure", class: "form-label mb-0" %>
                    <div class="form-check mb-0">
                      <%= check_box_tag :half_hour, "1", (@session.duration.to_f == 0.5),
                            class: "form-check-input",
                            id: "half_hour",
                            data: { session_form_target: "halfHour", action: "change->session-form#recheck" } %>
                      <%= label_tag :half_hour, "30 min", class: "form-check-label small" %>
                    </div>
                  </div>

                  <%= f.input :time, label: false, as: :string,
                        input_html: {
                          type: "text",
                          step: 900,
                          inputmode: "numeric",
                          value: (@session.occurred_at&.strftime("%H:%M") || default_time_slot_str),
                          class: "form-control form-control-sm",
                          data: { flatpickr_target: "time" }
                        } %>
                </div>
              </div>

              <div class="mb-3">
                <%= f.input :note, as: :text, label: "Note",
                      input_html: { rows: 1, class: "form-control form-control-sm" } %>
              </div>

              <div class="row g-3 align-items-center">
                <div class="col-12 col-sm-auto">
                  <div class="form-check">
                    <%= f.check_box :present,
                          class: "form-check-input",
                          id: "session_present",
                          data: { session_form_target: "present", action: "change->session-form#recheck" } %>
                    <%= f.label :present, "Présent·e", class: "form-check-label fw-semibold fs-6", for: "session_present" %>
                  </div>
                </div>

                <div class="col-12">
                  <button type="submit"
                          class="btn btn-primary rounded-pill shadow-sm w-100"
                          data-session-form-target="submit"
                          data-action="click->session-form#maybeConfirm"
                          disabled
                          data-modal-primary-label="<%= sessions_modal_primary_label %>"
                          data-modal-secondary-label="<%= sessions_modal_secondary_label %>"
                          data-modal-free-title="<%= sessions_modal_absence_free_title %>"
                          data-modal-free-body="<%= sessions_modal_absence_free_body %>"
                          data-modal-paid-title="<%= sessions_modal_absence_paid_title %>"
                          data-modal-paid-body="<%= sessions_modal_absence_paid_body %>">
                    Créer la séance
                  </button>
                </div>
              </div>

              <%= render "shared/modal" %>
            <% end %>
          </div>

          <!-- Pane: Consultation form -->
          <div data-segmented-tabs-target="pane" data-value="consultation" class="<%= @active_tab == 'consultation' ? '' : 'd-none' %>">
            <%= simple_form_for @consultation,
                url: consultations_path,
                html: { class: "session-form" } do |f| %>

              <div class="row g-3 align-items-end mb-2">
                <div class="col-12"><%= f.input :first_name,   label: "Prénom",      input_html: { class: "form-control form-control-sm" } %></div>
                <div class="col-12"><%= f.input :last_name,    label: "Nom",         input_html: { class: "form-control form-control-sm" } %></div>
                <div class="col-12"><%= f.input :email,        label: "Courriel",    input_html: { class: "form-control form-control-sm", inputmode: "email" } %></div>
                <div class="col-12"><%= f.input :phone_number, label: "Téléphone",   input_html: { class: "form-control form-control-sm", inputmode: "tel" } %></div>

                <% if @staff.any? %>
                  <div class="col-12">
                    <label for="consultation_user_id" class="form-label">Créé par</label>
                    <select name="consultation[user_id]" id="consultation_user_id" class="form-select form-select-sm">
                      <option value="">Moi (<%= current_user.full_name %>)</option>
                      <% @staff.each do |u| %>
                        <option value="<%= u.id %>"><%= u.full_name %></option>
                      <% end %>
                    </select>
                  </div>
                <% end %>
              </div>

              <hr class="my-3">

              <div class="row g-3 align-items-end mb-2" data-controller="flatpickr">
                <div class="col-md-6">
                  <%= f.input :date, label: "Date", as: :string,
                        input_html: {
                          type: "text",
                          value: (@consultation.occurred_at&.to_date || Date.today),
                          class: "form-control form-control-sm",
                          data: { flatpickr_target: "date" }
                        } %>
                </div>

                <div class="col-md-6">
                  <%= f.label :time, "Heure", class: "form-label mb-0" %>
                  <%= f.input :time, label: false, as: :string,
                        input_html: {
                          type: "text",
                          step: 900,
                          inputmode: "numeric",
                          value: (@consultation.occurred_at&.strftime("%H:%M") || "09:00"),
                          class: "form-control form-control-sm",
                          data: { flatpickr_target: "time" }
                        } %>
                </div>
              </div>

              <div class="mb-3">
                <%= f.input :note, as: :text, label: "Note",
                      input_html: { rows: 1, class: "form-control form-control-sm" } %>
              </div>

              <div class="row g-3 align-items-center">
                <div class="col-12 col-sm-auto">
                  <div class="form-check">
                    <%= f.check_box :present,
                          class: "form-check-input",
                          id: "consultation_present" %>
                    <%= f.label :present, "Présent·e", class: "form-check-label fw-semibold fs-6", for: "consultation_present" %>
                  </div>
                </div>

                <div class="col-12">
                  <button type="submit" class="btn btn-primary rounded-pill shadow-sm w-100">
                    Créer la consultation
                  </button>
                </div>
              </div>
            <% end %>
          </div>
        </div> <!-- /card-body -->
      </div>
    </div>

    <!-- RIGHT: Follows selected form; cards do not extend past viewport -->
    <div class="col-12 col-lg-9 d-flex">
      <div class="card shadow-sm stretch-card h-100 w-100">
        <!-- Constrain to viewport; internal panes scroll -->
        <div class="card-body p-3 d-flex flex-column" style="max-height: calc(100vh - 180px);">
          <!-- Right pane for SESSION: split vertically, each half scrolls -->
          <div data-segmented-tabs-target="pane" data-value="session"
               class="d-flex flex-column gap-3 <%= @active_tab == 'session' ? '' : 'd-none' %>"
               style="min-height:0; height:100%;">
            <!-- Top: Services (half height) -->
            <div class="pane pane-services d-flex flex-column" style="flex:1 1 0; min-height:0;">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h2 class="h6 mb-0">Services du client</h2>
              </div>

              <div class="flex-grow-1" style="min-height:0; overflow:auto;">
                <% if @session.fliip_user_id.present? && @services&.any? %>
                  <%= turbo_frame_tag "services_table" do %>
                    <div class="table-scroll">
                      <%= render "fliip_services/shared/services_table", services: @services %>
                    </div>
                  <% end %>
                <% else %>
                  <%= turbo_frame_tag "services_table" %>
                <% end %>
              </div>
            </div>

            <!-- Bottom: Sessions (half height) -->
            <div class="pane pane-sessions d-flex flex-column" style="flex:1 1 0; min-height:0;">
              <div class="d-flex align-items-center justify-content-between mb-1">
                <h2 class="h6 mb-0">Séances récentes</h2>
              </div>
              <p class="text-muted small mb-2">25 dernières séances non confirmées créées par vous.</p>

              <div class="flex-grow-1" style="min-height:0; overflow:auto;">
                <div class="table-scroll">
                  <%= render "sessions/shared/sessions_table",
                        sessions: @sessions,
                        show_bulk_checkbox: false,
                        scope_name: :booking_page %>
                </div>
              </div>
            </div>
          </div>

          <!-- Right pane for CONSULTATION: full height table with internal scroll -->
          <div data-segmented-tabs-target="pane" data-value="consultation"
               class="<%= @active_tab == 'consultation' ? '' : 'd-none' %>"
               style="min-height:0; height:100%; display:flex; flex-direction:column;">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <h2 class="h6 mb-0">Consultations non confirmées</h2>
            </div>
            <div class="flex-grow-1" style="min-height:0; overflow:auto;">
              <% if @consultations&.any? %>
                <div class="table-scroll">
                  <%= render "consultations/shared/consultations_table", consultations: @consultations %>
                </div>
              <% else %>
                <div class="text-muted small">Aucune consultation non confirmée.</div>
              <% end %>
            </div>
          </div>
        </div> <!-- /card-body -->
      </div>
    </div>
  </div> <!-- /row -->
</div>
