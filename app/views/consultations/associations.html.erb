<div class="container mt-4">
  <!-- Page header row -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Associations de consultations</h1>
  </div>

  <div class="row g-4 align-items-stretch">
    <!-- LEFT: Filters -->
    <div class="col-12 col-lg-3 d-flex">
      <div class="card shadow-sm stretch-card h-100 w-100">
        <div class="card-body p-3">
          <%= form_with url: associations_consultations_path,
                        method: :get,
                        local: true,
                        class: "d-flex flex-wrap align-items-end gap-2",
                        data: { controller: "flatpickr" } do %>

            <!-- Search -->
            <div class="d-flex flex-column" style="flex:1 1 280px;">
              <%= label_tag :q, "Recherche (client·e)", class: "form-label" %>
              <%= text_field_tag :q, @filter_params[:q],
                  class: "form-control", placeholder: "Nom, courriel ou téléphone" %>
            </div>

            <!-- Employee -->
            <div class="d-flex flex-column" style="flex:1 1 280px;">
              <%= label_tag :employee_id, "Employé·e", class: "form-label" %>
              <%= select_tag :employee_id,
                    options_for_select([["—", nil]] + Array(@staff).map { |u| ["#{u.first_name} #{u.last_name}", u.id] }, @filter_params[:employee_id]),
                    class: "form-select" %>
            </div>

            <!-- Consultation date range -->
            <div class="d-flex flex-column" style="flex:1 1 280px;">
              <%= label_tag :consultation_date_range, "Dates de consultation", class: "form-label" %>
              <%= text_field_tag :consultation_date_range, nil,
                    name: nil,
                    class: "form-control",
                    placeholder: "Sélectionner une période",
                    data: { flatpickr_target: "sessionRange" } %>
              <%= hidden_field_tag :consultation_date_from, @filter_params[:consultation_date_from],
                    data: { flatpickr_target: "sessionFromHidden" } %>
              <%= hidden_field_tag :consultation_date_to, @filter_params[:consultation_date_to],
                    data: { flatpickr_target: "sessionToHidden" } %>
            </div>

            <!-- Created range -->
            <div class="d-flex flex-column" style="flex:1 1 280px;">
              <%= label_tag :created_range, "Créé (période)", class: "form-label" %>
              <%= text_field_tag :created_range, nil,
                    name: nil,
                    class: "form-control",
                    placeholder: "Sélectionner une période",
                    data: { flatpickr_target: "createdRange" } %>
              <%= hidden_field_tag :created_from, @filter_params[:created_from],
                    data: { flatpickr_target: "createdFromHidden" } %>
              <%= hidden_field_tag :created_to, @filter_params[:created_to],
                    data: { flatpickr_target: "createdToHidden" } %>
            </div>

            <!-- Présence -->
            <div class="row w-100 gx-3">
              <div class="col-12">
                <label class="form-label d-block mb-1 small">Présence</label>
                <div class="form-check form-check-inline">
                  <%= check_box_tag "present[]", "yes", Array(@filter_params[:present]).include?("yes"),
                        id: "present_yes", class: "form-check-input" %>
                  <%= label_tag "present_yes", "Oui", class: "form-check-label" %>
                </div>
                <div class="form-check form-check-inline">
                  <%= check_box_tag "present[]", "no", Array(@filter_params[:present]).include?("no"),
                        id: "present_no", class: "form-check-input" %>
                  <%= label_tag "present_no", "Non", class: "form-check-label" %>
                </div>
              </div>
            </div>

            <!-- Filter actions -->
            <div class="d-flex gap-2" style="flex:0 0 auto;">
              <%= submit_tag "Filtrer", class: "btn btn-primary" %>
              <%= link_to "Réinitialiser", associations_consultations_path, class: "btn btn-outline-secondary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- RIGHT: Data table -->
    <div class="col-12 col-lg-9 d-flex">
      <div class="card shadow-sm stretch-card h-100 w-100">
        <div class="card-body p-3 scrollable-card-body">
          <div class="table-scroll">
            <% if @consultations.any? %>
              <%= render "consultations/shared/consultations_table",
                         consultations: @consultations,
                         show_bulk_checkbox: false,
                         inline_edit: true,
                         scope_name: :unassociated %>
            <% else %>
              <div class="text-center text-muted py-5">
                <p class="mb-0">Aucune consultation à associer pour les filtres actuels.</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
