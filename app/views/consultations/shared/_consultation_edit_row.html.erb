<% c = consultation %>

<tr id="<%= dom_id(c) %>"
    data-controller="consultation-row"
    data-consultation-row-id-value="<%= c.id %>"
    data-consultation-row-edit-url-value="<%= edit_consultation_path(c) %>"
    data-consultation-row-row-url-value="<%= row_consultation_path(c) %>"
    data-consultation-row-update-url-value="<%= consultation_path(c) %>"
    data-consultation-row-show-bulk-value="<%= local_assigns[:show_bulk_checkbox].present? %>">

  <%# 1) Optional bulk checkbox placeholder to preserve columns %>
  <% if local_assigns[:show_bulk_checkbox] %>
    <td></td>
  <% end %>

  <%# 2) Date · Présence (now edited in-place in its own cell) %>
  <td class="small align-middle">
    <div class="row g-2 align-items-center" data-controller="flatpickr">
      <div class="col-auto">
        <%= label_tag :consultation_date, "Date", class: "form-label small mb-0" %>
        <%= text_field_tag "consultation[date]",
              (c.occurred_at&.to_date&.strftime("%Y-%m-%d") || Date.current.strftime("%Y-%m-%d")),
              class: "form-control form-control-sm",
              placeholder: "YYYY-MM-DD",
              data: { flatpickr_target: "date" } %>
      </div>

      <div class="col-auto">
        <%= label_tag :consultation_time, "Heure", class: "form-label small mb-0" %>
        <%= text_field_tag "consultation[time]",
              (c.occurred_at&.strftime("%H:%M") || "09:00"),
              class: "form-control form-control-sm",
              step: 900,
              inputmode: "numeric",
              placeholder: "HH:MM",
              data: { flatpickr_target: "time" } %>
      </div>

      <div class="col-auto">
        <%= label_tag :consultation_present, "Présence", class: "form-label small mb-0 d-block" %>
        <div class="form-check mt-1">
          <%= check_box_tag "consultation[present]", "1", c.present?, class: "form-check-input", id: "consultation_present_#{c.id}" %>
          <%= label_tag "consultation_present_#{c.id}", "Oui", class: "form-check-label small" %>
        </div>
      </div>
    </div>
  </td>

  <%# 3) Client name (editable) %>
  <td class="align-middle">
    <div class="row g-2">
      <div class="col-auto">
        <%= label_tag :consultation_first_name, "Prénom", class: "form-label small mb-0" %>
        <%= text_field_tag "consultation[first_name]", c.first_name, class: "form-control form-control-sm", maxlength: 255 %>
      </div>
      <div class="col-auto">
        <%= label_tag :consultation_last_name, "Nom", class: "form-label small mb-0" %>
        <%= text_field_tag "consultation[last_name]", c.last_name, class: "form-control form-control-sm", maxlength: 255 %>
      </div>
    </div>
  </td>

  <%# 4) Contact info (editable) %>
  <td class="align-middle">
    <div class="row g-2">
      <div class="col-auto">
        <%= label_tag :consultation_email, "Courriel", class: "form-label small mb-0" %>
        <%= email_field_tag "consultation[email]", c.email, class: "form-control form-control-sm", maxlength: 255, autocomplete: "email" %>
      </div>
      <div class="col-auto">
        <%= label_tag :consultation_phone_number, "Téléphone", class: "form-label small mb-0" %>
        <%= telephone_field_tag "consultation[phone_number]", c.phone_number, class: "form-control form-control-sm", maxlength: 50, autocomplete: "tel" %>
      </div>
    </div>
  </td>

  <%# 5) Employee %>
  <td class="text-nowrap align-middle text-center">
    <% if current_user.admin? || (current_user.respond_to?(:super_admin?) && current_user.super_admin?) %>
      <label class="form-label small mb-0 d-block">Employé·e</label>
      <select name="consultation[user_id]" class="form-select form-select-sm">
        <% @staff.each do |u| %>
          <option value="<%= u.id %>" <%= "selected" if u.id == c.user_id %>><%= u.full_name %></option>
        <% end %>
      </select>
      <% if c.created_by_id.present? && c.created_by_id != c.user_id %>
        <div class="small text-muted mt-1">créée par <%= c.created_by&.full_name %></div>
      <% end %>
    <% else %>
      <% if c.user %>
        <%= link_to c.user.full_name, user_path(c.user), class: "text-decoration-none" %>
        <% if c.created_by_id.present? && c.created_by_id != c.user_id %>
          <div class="small text-muted">créée par <%= c.created_by&.full_name %></div>
        <% end %>
      <% else %>
        <span class="text-muted">—</span>
      <% end %>
    <% end %>
  </td>

  <%# 6) Actions %>
  <td class="text-end align-middle text-nowrap">
    <a  href="<%= row_consultation_path(c) %>"
        class="btn btn-sm btn-outline-secondary me-1"
        data-action="consultation-row#cancel">
      Annuler
    </a>
    <button type="button"
            class="btn btn-sm btn-primary"
            data-action="consultation-row#save">
      Enregistrer
    </button>
  </td>
</tr>

<tr class="note-row" id="<%= dom_id(c, :note) %>">
  <td colspan="<%= (local_assigns[:show_bulk_checkbox] ? 6 : 5) %>" class="py-1">
    <div class="small">
      <strong>Note :</strong>
      <textarea name="consultation[note]" rows="1" class="form-control form-control-sm d-inline-block mt-1"><%= c.note %></textarea>
    </div>
  </td>
</tr>
