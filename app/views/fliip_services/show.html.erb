<div class="container mt-4">
  <div class="row g-4">
    <!-- LEFT: Summary -->
    <div class="col-12 col-lg-3">
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <h1 class="mb-0">
          <%= @service.service_name.presence || "Service ##{@service.id}" %>
        </h1>
      </div>

      <div class="card shadow-sm stretch-card">
        <div class="card-body p-3">
          <% badge_class =
               case @service.purchase_status
               when "A" then "bg-success"
               when "P" then "bg-info text-dark"
               when "S" then "bg-warning text-dark"
               when "C" then "bg-danger"
               else           "bg-secondary"
               end %>

          <div class="mb-2">
            <div class="text-muted small">Client·e</div>
            <div class="fw-bold">
              <%= link_to @service.fliip_user.full_name,
                          fliip_user_path(@service.fliip_user),
                          class: "text-decoration-none" %>
            </div>
          </div>

          <div class="mb-2">
            <div class="text-muted small">Statut</div>
            <span class="badge <%= badge_class %>"><%= @service.status_name %></span>
          </div>

          <div class="mb-2">
            <div class="text-muted small">Identifiants</div>
            <div class="small">
              <div><strong>Service # :</strong> <%= @service.id %></div>
              <div><strong>Achat # :</strong> <%= @service.remote_purchase_id || "—" %></div>
              <div><strong>ID déf. :</strong> <%= @service.service_definition&.service_id || @service.service_id || "—" %></div>
            </div>
          </div>

          <div class="mb-2">
            <div class="text-muted small">Séances incluses</div>
            <div class="small">
              Chargées : <strong><%= @service.service_definition&.paid_sessions || "—" %></strong>
              &nbsp;•&nbsp;
              Absences : <strong><%= @service.service_definition&.free_sessions || "—" %></strong>
            </div>
          </div>

          <div class="mb-2">
            <div class="text-muted small">Période</div>
            <div class="small">
              Début : <strong><%= @service.start_date&.strftime("%d/%m/%Y") || "—" %></strong>
              &nbsp;•&nbsp;
              Fin : <strong><%= @service.expire_date&.strftime("%d/%m/%Y") || "—" %></strong>
            </div>
            <div class="small text-muted mt-1">
              <span>Acheté : <strong><%= @service.purchase_date&.strftime("%d/%m/%Y") || "—" %></strong></span>
              &nbsp;•&nbsp;
              <span>Arrêt : <strong><%= @service.stop_date&.strftime("%d/%m/%Y") || "—" %></strong></span>
              &nbsp;•&nbsp;
              <span>Annulé : <strong><%= @service.cancel_date&.strftime("%d/%m/%Y") || "—" %></strong></span>
            </div>
          </div>

          <div class="mt-3">
            <div class="d-grid">
              <%= link_to "← Retour à la fiche client·e",
                          fliip_user_path(@service.fliip_user),
                          class: "btn btn-outline-secondary" %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Tabs (header) + Card (content) -->
    <div class="col-12 col-lg-9">
      <div class="tab-header" data-controller="tabs">
        <nav>
          <div class="nav nav-tabs" id="service-tablist" role="tablist">
            <button
              class="nav-link active"
              id="tab-sessions"
              type="button"
              role="tab"
              aria-controls="pane-sessions"
              aria-selected="true"
              data-bs-target="#pane-sessions"
              data-action="click->tabs#activate">
              Séances
            </button>

            <% if current_user.manager? || current_user.admin? || current_user.super_admin? %>
              <button
                class="nav-link"
                id="tab-adjustments"
                type="button"
                role="tab"
                aria-controls="pane-adjustments"
                aria-selected="false"
                data-bs-target="#pane-adjustments"
                data-action="click->tabs#activate">
                Ajustements
              </button>
            <% end %>
          </div>
        </nav>

        <div class="card shadow-sm stretch-card">
          <div class="card-body p-3 scrollable-card-body">
            <div id="service-tabcontent">
              <!-- Sessions (default) -->
              <section id="pane-sessions" role="tabpanel" aria-labelledby="tab-sessions">
                <%= turbo_frame_tag "service_sessions_frame", target: "_top" do %>
                  <% time_pct = @service.time_progress_percent || 0 %>
                  <% paid_pct = @service.paid_progress_percent || 0 %>
                  <% paid_used     = @service.paid_used_total %>
                  <% total_allowed = @service.paid_allowed_total %>
                  <% paid_base     = @service.service_definition&.paid_sessions %>
                  <% bonus_total   = @service.bonus_sessions_total %>
                  <% free_used     = @service.free_used_total %>
                  <% free_base     = @service.service_definition&.free_sessions %>

                  <!-- Time bar -->
                  <div class="mb-3">
                    <div class="text-muted small mb-1">Temps</div>
                    <%= bar_with_label(
                          percent: time_pct,
                          label:   "#{@service.time_range_label} • #{time_pct}%",
                          bg_class: progress_base_color(time_pct)
                        ) %>
                  </div>

                  <!-- Sessions bar -->
                  <div class="mb-3">
                    <div class="d-flex justify-content-between small">
                      <span>
                        <%= "#{fmt1(paid_used)}/#{total_allowed.to_f.positive? ? fmt1(total_allowed) : '—'} séances" %>
                        <span class="text-muted">
                          (base : <%= paid_base.nil? ? "—" : paid_base %><% if bonus_total.to_f.nonzero? %>, bonus : <%= fmt1(bonus_total) %><% end %>)
                        </span>
                      </span>
                      <span>
                        <%= paid_pct %>%
                        <span class="ms-2 text-muted">[<%= fmt1(free_used) %>/<%= free_base.nil? ? '—' : free_base %> absences]</span>
                      </span>
                    </div>

                    <%= bar_with_label(
                          percent: paid_pct,
                          label:   "#{@service.paid_usage_compact_str} #{@service.absences_compact_str} • #{paid_pct}%",
                          bg_class: progress_usage_color(paid_pct, time_pct)
                        ) %>
                  </div>

                  <div class="table-scroll">
                    <%= render "sessions/shared/sessions_table",
                        sessions: @sessions,
                        show_bulk_checkbox: false,
                        scope_name: :new_session,
                        show_adjustment: true,
                        fliip_service: @service %>
                  </div>
                <% end %>
              </section>

              <!-- Adjustments (role-gated) -->
              <% if current_user.manager? || current_user.admin? || current_user.super_admin? %>
                <section class="d-none" id="pane-adjustments" role="tabpanel" aria-labelledby="tab-adjustments">
                  <%= turbo_frame_tag "service_adjustments_frame", target: "_top" do %>
                    <div class="row g-3 mb-2">
                      <div class="col-md-4">
                        <div class="small text-muted">Total des séances bonus</div>
                        <div class="fw-semibold"><%= fmt1(@service.bonus_sessions_total) %></div>
                      </div>
                      <div class="col-md-4">
                        <div class="small text-muted">Chargées utilisées (ajustements seulement)</div>
                        <div class="fw-semibold"><%= fmt1(@service.paid_used_adjustment) %></div>
                      </div>
                      <div class="col-md-4">
                        <div class="small text-muted">Absences utilisées (ajustements seulement)</div>
                        <div class="fw-semibold"><%= fmt1(@service.free_used_adjustment) %></div>
                      </div>
                    </div>

                    <% if @adjustments.any? %>
                      <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle">
                          <thead class="table-light">
                            <tr>
                              <th>Date</th>
                              <th>Employé·e</th>
                              <th class="text-end">Chargées utilisées Δ</th>
                              <th class="text-end">Absences utilisées Δ</th>
                              <th class="text-end">Séances bonus Δ</th>
                              <% if current_user.admin? || current_user.super_admin? %>
                                <th class="text-end" style="width:1%;">Actions</th>
                              <% end %>
                            </tr>
                          </thead>
                          <tbody>
                            <% @adjustments.each do |adj| %>
                              <tr>
                                <td><%= adj.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                                <td><%= adj.user&.full_name || "—" %></td>
                                <td class="text-end"><%= adj.paid_used_delta.to_f.zero? ? "—" : fmt1(adj.paid_used_delta) %></td>
                                <td class="text-end"><%= adj.free_used_delta.to_f.zero? ? "—" : fmt1(adj.free_used_delta) %></td>
                                <td class="text-end"><%= adj.bonus_sessions.to_f.zero? ? "—" : fmt1(adj.bonus_sessions) %></td>
                                <% if current_user.admin? || current_user.super_admin? %>
                                  <td class="text-end align-middle text-nowrap">
                                    <%= link_to edit_fliip_service_service_usage_adjustment_path(@service, adj),
                                          class: "btn btn-sm btn-outline-secondary me-1",
                                          title: "Modifier" do %>
                                      <i class="fa-solid fa-pencil"></i>
                                    <% end %>

                                    <%= button_to fliip_service_service_usage_adjustment_path(@service, adj),
                                          method: :delete,
                                          data: { turbo_confirm: "Supprimer cet ajustement ?" },
                                          class: "btn btn-sm btn-outline-danger d-inline-flex align-items-center",
                                          form: { class: "d-inline" } do %>
                                      <i class="fa-solid fa-trash-can"></i>
                                    <% end %>
                                  </td>
                                <% end %>
                              </tr>
                            <% end %>
                          </tbody>
                        </table>
                      </div>
                    <% else %>
                      <p class="text-muted mb-0">Aucun ajustement enregistré pour ce service.</p>
                    <% end %>

                    <div class="card mt-3">
                      <div class="card-body">
                        <h5 class="card-title mb-2">Ajouter un ajustement</h5>
                        <% @adjustment = @service.service_usage_adjustments.new(user: current_user) %>
                        <%= render "service_usage_adjustments/form",
                              service: @service,
                              adjustment: @adjustment,
                              cancel_path: fliip_service_path(@service) %>
                      </div>
                    </div>
                  <% end %>
                </section>
              <% end %>
            </div>
          </div>
        </div>
      </div><!-- /tabs controller scope -->
    </div>
  </div>
</div>
