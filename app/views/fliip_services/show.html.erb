<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">
      <%= @service.service_name.presence || "Service ##{@service.id}" %>
      <small class="text-muted">(#<%= @service.remote_purchase_id %>)</small>
    </h1>
    <%= link_to "← Back to Client",
                fliip_user_path(@service.fliip_user),
                class: "btn btn-outline-secondary" %>
  </div>

  <!-- Summary -->
  <div class="row g-3 mb-4">
    <!-- Client / Status -->
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Client</div>
          <div class="fw-bold">
            <%= link_to @service.fliip_user.full_name,
                        fliip_user_path(@service.fliip_user),
                        class: "text-decoration-none" %>
          </div>
          <div class="text-muted small">Remote Purchase: <%= @service.remote_purchase_id || "—" %></div>

          <% badge_class =
               case @service.purchase_status
               when "A" then "bg-success"
               when "P" then "bg-info text-dark"
               when "S" then "bg-warning text-dark"
               when "C" then "bg-danger"
               else           "bg-secondary"
               end %>
          <div class="text-muted small">
            Status:
            <span class="badge <%= badge_class %>"><%= @service.status_name %></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Dates + Time Progress -->
    <div class="col-md-5">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Dates</div>
          <div>
            Start: <strong><%= @service.start_date || "—" %></strong>
            &nbsp;•&nbsp;
            End: <strong><%= @service.expire_date || "—" %></strong>
          </div>

          <% time_pct = svc_time_progress_percent(@service) %>
          <% time_bg, time_text = progress_color_classes(time_pct) %>

          <div class="d-flex justify-content-between small mt-2">
            <span>Time</span>
            <span><%= svc_time_range_label(@service) %> • <%= time_pct %>%</span>
          </div>
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= time_pct %>">
            <div class="progress-bar <%= time_bg %> <%= time_text %>" style="width: <%= time_pct %>%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sessions (progress uses total allowed = base + bonus) -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <% paid_used    = @service.paid_used_total %>
          <% paid_base    = @service.service_definition&.paid_sessions %>
          <% bonus_total  = @service.bonus_sessions_total %>
          <% total_allowed = @service.paid_allowed_total %> <!-- base + bonus -->
          <% pct          = @service.paid_progress_percent || 0 %>
          <% bar_bg, bar_text = progress_color_classes(pct) %>

          <% free_used    = @service.free_used_total %>
          <% free_base    = @service.service_definition&.free_sessions %>

          <div class="text-muted small mb-1">Sessions</div>

          <div class="d-flex justify-content-between small">
            <span>
              <%= "#{fmt1(paid_used)}/#{total_allowed.to_f.positive? ? fmt1(total_allowed) : '—'} sessions" %>
              <span class="text-muted">
                (base: <%= paid_base.nil? ? "—" : paid_base %>
                <% if bonus_total.to_f.nonzero? %>, bonus: <%= fmt1(bonus_total) %><% end %>)
              </span>
            </span>
            <span>
              <%= pct %>%
              <span class="ms-2 text-muted">[<%= fmt1(free_used) %>/<%= free_base.nil? ? '—' : free_base %> absences]</span>
            </span>
          </div>

          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= pct %>">
            <div class="progress-bar <%= bar_bg %> <%= bar_text %>" style="width: <%= pct %>%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Included (definition) -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body py-2">
          <div class="small text-muted">Included sessions</div>
          <div>
            Paid: <strong><%= @service.service_definition&.paid_sessions || "—" %></strong>
            &nbsp;•&nbsp;
            Free: <strong><%= @service.service_definition&.free_sessions || "—" %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Adjustments -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Adjustments</h5>
      </div>

      <div class="row g-3 mb-2">
        <div class="col-md-4">
          <div class="small text-muted">Bonus sessions total</div>
          <div class="fw-semibold"><%= fmt1(@service.bonus_sessions_total) %></div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Paid used (adjustments only)</div>
          <div class="fw-semibold"><%= fmt1(@service.paid_used_adjustment) %></div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Free used (adjustments only)</div>
          <div class="fw-semibold"><%= fmt1(@service.free_used_adjustment) %></div>
        </div>
      </div>

      <% if @adjustments.any? %>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th style="min-width: 140px;">Date</th>
                <th>Employee</th>
                <th class="text-end">Paid Used Δ</th>
                <th class="text-end">Free Used Δ</th>
                <th class="text-end">Bonus Sessions Δ</th>
              </tr>
            </thead>
            <tbody>
              <% @adjustments.each do |adj| %>
                <tr>
                  <td><%= adj.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                  <td><%= adj.user&.full_name || "—" %></td>
                  <td class="text-end"><%= adj.paid_used_delta.to_f.zero? ? "—" : fmt1(adj.paid_used_delta) %></td>
                  <td class="text-end"><%= adj.free_used_delta.to_f.zero? ? "—" : fmt1(adj.free_used_delta) %></td>
                  <td class="text-end"><%= adj.bonus_sessions.to_f.zero? ? "—" : fmt1(adj.bonus_sessions) %></td>
                  <% if current_user.admin? || current_user.super_admin? %>
                    <td class="text-end">
                      <%= link_to "Edit", edit_fliip_service_service_usage_adjustment_path(@service, adj), class: "btn btn-sm btn-outline-primary" %>
                      <%= button_to "Delete",
                            fliip_service_service_usage_adjustment_path(@service, adj),
                            method: :delete,
                            data: { turbo_confirm: "Delete this adjustment?" },
                            class: "btn btn-sm btn-outline-danger" %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted mb-0">No adjustments recorded for this service.</p>
      <% end %>
      <div class="card mt-3">
        <div class="card-body">
          <h5 class="card-title mb-2">Add Adjustment</h5>
          <% @adjustment = @service.service_usage_adjustments.new(user: current_user) %>
          <%= render "service_usage_adjustments/form", cancel_path: fliip_service_path(@service) %>
        </div>
      </div>
    </div>
  </div>

  <!-- Sessions Table -->
    <%= render "shared/sessions_table",
        sessions: @sessions,
        show_bulk_checkbox: false,
        scope_name: :new_session %>

  <div class="d-flex justify-content-end">
    <%== pagy_bootstrap_nav(@pagy) %>
  </div>
</div>
