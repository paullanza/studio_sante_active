<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">
      <%= @service.service_name.presence || "Service ##{@service.id}" %>
      <small class="text-muted">(#<%= @service.remote_purchase_id %>)</small>
    </h1>
    <%= link_to "← Retour à la fiche client·e",
                fliip_user_path(@service.fliip_user),
                class: "btn btn-outline-secondary" %>
  </div>

  <!-- Summary (merged cards) -->
  <div class="row g-3 mb-4">
    <!-- Card 1: Client + Service + Included -->
    <div class="col-lg-5">
      <div class="card h-100">
        <div class="card-body">
          <% badge_class =
               case @service.purchase_status
               when "A" then "bg-success"
               when "P" then "bg-info text-dark"
               when "S" then "bg-warning text-dark"
               when "C" then "bg-danger"
               else           "bg-secondary"
               end %>

          <div class="text-muted small mb-1">Client·e</div>
          <div class="fw-bold">
            <%= link_to @service.fliip_user.full_name,
                        fliip_user_path(@service.fliip_user),
                        class: "text-decoration-none" %>
          </div>

          <div class="text-muted small mt-2">Service</div>
          <div class="d-flex flex-column">
            <div>
              <span class="me-2"><strong>Service # :</strong> <%= @service.id %></span>
              <span class="me-2"><strong>Achat # :</strong> <%= @service.remote_purchase_id || "—" %></span>
              <span><strong>ID déf. :</strong> <%= @service.service_definition&.service_id || @service.service_id || "—" %></span>
            </div>
          </div>

          <div class="text-muted small mt-2">Statut</div>
          <div>
            <span class="badge <%= badge_class %>"><%= @service.status_name %></span>
          </div>

          <hr class="my-3">

          <div class="small text-muted">Séances incluses</div>
          <div>
            Chargées : <strong><%= @service.service_definition&.paid_sessions || "—" %></strong>
            &nbsp;•&nbsp;
            Absences : <strong><%= @service.service_definition&.free_sessions || "—" %></strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 2: Progress (Time + Sessions) -->
    <div class="col-lg-7">
      <div class="card h-100">
        <div class="card-body">
          <% start_d  = @service.start_date&.strftime("%d/%m/%Y") || "—" %>
          <% end_d    = @service.expire_date&.strftime("%d/%m/%Y") || "—" %>
          <% time_pct = @service.time_progress_percent || 0 %>
          <% paid_pct = @service.paid_progress_percent || 0 %>

          <div class="text-muted small">Période</div>
          <div>
            Début : <strong><%= start_d %></strong>
            &nbsp;•&nbsp;
            Fin : <strong><%= end_d %></strong>
          </div>

          <div class="small text-muted mt-1">
            <span>Acheté : <strong><%= @service.purchase_date&.strftime("%d/%m/%Y") || "—" %></strong></span>
            &nbsp;•&nbsp;
            <span>Arrêt : <strong><%= @service.stop_date&.strftime("%d/%m/%Y") || "—" %></strong></span>
            &nbsp;•&nbsp;
            <span>Annulé : <strong><%= @service.cancel_date&.strftime("%d/%m/%Y") || "—" %></strong></span>
          </div>

          <!-- Time bar -->
          <div class="mt-2">
            <%= bar_with_label(
                  percent: time_pct,
                  label:   "#{@service.time_range_label} • #{time_pct}%",
                  bg_class: progress_base_color(time_pct)
                ) %>
          </div>

          <!-- Sessions bar -->
          <div class="mt-3">
            <% paid_used     = @service.paid_used_total %>
            <% total_allowed = @service.paid_allowed_total %>  <%# base + bonus %>
            <% paid_base     = @service.service_definition&.paid_sessions %>
            <% bonus_total   = @service.bonus_sessions_total %>
            <% free_used     = @service.free_used_total %>
            <% free_base     = @service.service_definition&.free_sessions %>

            <div class="d-flex justify-content-between small">
              <span>
                <%= "#{fmt1(paid_used)}/#{total_allowed.to_f.positive? ? fmt1(total_allowed) : '—'} séances" %>
                <span class="text-muted">
                  (base : <%= paid_base.nil? ? "—" : paid_base %><% if bonus_total.to_f.nonzero? %>
                    , bonus : <%= fmt1(bonus_total) %>
                  <% end %>)
                </span>
              </span>
              <span>
                <%= paid_pct %>%
                <span class="ms-2 text-muted">[<%= fmt1(free_used) %>/<%= free_base.nil? ? '—' : free_base %> absences]</span>
              </span>
            </div>

            <%= bar_with_label(
                  percent: paid_pct,
                  label:   "#{@service.paid_usage_compact_str} #{@service.absences_compact_str} • #{paid_pct}%",
                  bg_class: progress_usage_color(paid_pct, time_pct)
                ) %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Adjustments -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Ajustements</h5>
      </div>

      <div class="row g-3 mb-2">
        <div class="col-md-4">
          <div class="small text-muted">Total des séances bonus</div>
          <div class="fw-semibold"><%= fmt1(@service.bonus_sessions_total) %></div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Chargées utilisées (ajustements seulement)</div>
          <div class="fw-semibold"><%= fmt1(@service.paid_used_adjustment) %></div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Absences utilisées (ajustements seulement)</div>
          <div class="fw-semibold"><%= fmt1(@service.free_used_adjustment) %></div>
        </div>
      </div>

      <% if @adjustments.any? %>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th style="min-width: 140px;">Date</th>
                <th>Employé·e</th>
                <th class="text-end">Chargées utilisées Δ</th>
                <th class="text-end">Absences utilisées Δ</th>
                <th class="text-end">Séances bonus Δ</th>
                <% if current_user.admin? || current_user.super_admin? %>
                  <th class="text-end" style="width:1%;">Actions</th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% @adjustments.each do |adj| %>
                <tr>
                  <td><%= adj.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                  <td><%= adj.user&.full_name || "—" %></td>
                  <td class="text-end"><%= adj.paid_used_delta.to_f.zero? ? "—" : fmt1(adj.paid_used_delta) %></td>
                  <td class="text-end"><%= adj.free_used_delta.to_f.zero? ? "—" : fmt1(adj.free_used_delta) %></td>
                  <td class="text-end"><%= adj.bonus_sessions.to_f.zero? ? "—" : fmt1(adj.bonus_sessions) %></td>
                  <% if current_user.admin? || current_user.super_admin? %>
                    <td class="text-end">
                      <%= link_to "Modifier", edit_fliip_service_service_usage_adjustment_path(@service, adj), class: "btn btn-sm btn-outline-primary" %>
                      <%= button_to "Supprimer",
                            fliip_service_service_usage_adjustment_path(@service, adj),
                            method: :delete,
                            data: { turbo_confirm: "Supprimer cet ajustement ?" },
                            class: "btn btn-sm btn-outline-danger" %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted mb-0">Aucun ajustement enregistré pour ce service.</p>
      <% end %>

      <div class="card mt-3">
        <div class="card-body">
          <h5 class="card-title mb-2">Ajouter un ajustement</h5>
          <% @adjustment = @service.service_usage_adjustments.new(user: current_user) %>
          <%= render "service_usage_adjustments/form", cancel_path: fliip_service_path(@service) %>
        </div>
      </div>
    </div>
  </div>

  <!-- Sessions Table -->
  <%= render "sessions/shared/sessions_table",
      sessions: @sessions,
      show_bulk_checkbox: false,
      scope_name: :new_session,
      show_adjustment: true,
      fliip_service: @service %>

  <div class="d-flex justify-content-end">
    <%== pagy_bootstrap_nav(@pagy) %>
  </div>
</div>
