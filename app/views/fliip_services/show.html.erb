<!-- app/views/fliip_services/show.html.erb -->
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">
      <%= @service.service_name.presence %>
      <small class="text-muted">(#<%= @service.remote_purchase_id %>)</small>
    </h1>
    <%= link_to "← Back to Client",
                fliip_user_path(@service.fliip_user),
                class: "btn btn-outline-secondary" %>
  </div>

  <!-- Summary -->
  <div class="row g-3 mb-4">
    <!-- Client / Status -->
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Client</div>
          <div class="fw-bold">
            <%= link_to @service.fliip_user.full_name,
                        fliip_user_path(@service.fliip_user),
                        class: "text-decoration-none" %>
          </div>
          <div class="text-muted small">Remote Purchase: <%= @service.remote_purchase_id || "—" %></div>
          <div class="text-muted small">Status: <span class="badge bg-secondary"><%= @status_label %></span></div>
        </div>
      </div>
    </div>

    <!-- Dates + Time Progress -->
    <div class="col-md-5">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted small">Dates</div>
          <div>
            Start: <strong><%= @service.start_date || "—" %></strong>
            &nbsp;•&nbsp;
            End: <strong><%= @service.expire_date || "—" %></strong>
          </div>

          <% sd = @service.start_date; ed = @service.expire_date %>
          <% time_pct =
               if sd.present? && ed.present? && ed > sd
                 span = (ed - sd).to_f
                 elapsed = (Date.current - sd).to_f
                 [[(elapsed / span * 100).round, 0].max, 100].min
               else
                 0
               end %>

          <div class="d-flex justify-content-between small mt-2">
            <span>Time</span>
            <span><%= sd&.strftime("%d/%m/%Y") || "—" %> → <%= ed&.strftime("%d/%m/%Y") || "—" %> • <%= time_pct %>%</span>
          </div>
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= time_pct %>">
            <div class="progress-bar bg-info" style="width: <%= time_pct %>%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sessions (paid bar + free bracket) -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <% fmt = ->(n) { ('%.1f' % n.to_f) } %>

          <% paid_used   = @paid_used.to_f %>
          <% paid_base   = @paid_total %>        <%# included from definition (may be nil) %>
          <% paid_bonus  = @paid_bonus.to_f %>
          <% paid_allow  = (paid_base.to_f.nonzero? ? paid_base.to_f : 0.0) + paid_bonus %>

          <% paid_pct =
               if paid_allow.positive?
                 [[((paid_used / paid_allow) * 100).round, 0].max, 100].min
               else
                 0
               end %>

          <% free_used   = @free_used.to_f %>
          <% free_total  = @free_total %>
          <% free_total_s = free_total.nil? ? "—" : free_total.to_s %>

          <div class="text-muted small mb-1">Sessions</div>
          <div class="d-flex justify-content-between small">
            <span>
              <%= "#{fmt.call(paid_used)}/#{paid_allow.positive? ? fmt.call(paid_allow) : '—'} sessions (paid)" %>
              <%# breakdown: base + bonus %>
              <span class="text-muted">
                (
                  <%= paid_base.nil? ? "—" : paid_base %> base
                  <% if paid_bonus.nonzero? %> + <%= fmt.call(paid_bonus) %> bonus<% end %>
                )
              </span>
            </span>
            <span>
              <%= paid_pct %>%
              <span class="ms-2 text-muted">[<%= fmt.call(free_used) %>/<%= free_total_s %> absences]</span>
            </span>
          </div>
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= paid_pct %>">
            <div class="progress-bar bg-success" style="width: <%= paid_pct %>%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Adjustments -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Adjustments</h5>
        <%# TODO: enable when edit is built %>
        <%#= link_to "Edit adjustments", edit_fliip_service_adjustments_path(@service), class: "btn btn-sm btn-outline-primary" %>
      </div>

      <div class="row g-3 mb-2">
        <div class="col-md-4">
          <div class="small text-muted">Paid bonus total</div>
          <div class="fw-semibold"><%= fmt.call(@paid_bonus || 0.0) %></div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Paid used (adjustments only)</div>
          <div class="fw-semibold"><%= fmt.call(@service.paid_used_adjustment) %></div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Free used (adjustments only)</div>
          <div class="fw-semibold"><%= fmt.call(@service.free_used_adjustment) %></div>
        </div>
      </div>

      <% if @adjustments.any? %>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th style="min-width: 140px;">Date</th>
                <th>Employee</th>
                <th class="text-end">Paid Used Δ</th>
                <th class="text-end">Free Used Δ</th>
                <th class="text-end">Paid Bonus Δ</th>
              </tr>
            </thead>
            <tbody>
              <% @adjustments.each do |adj| %>
                <tr>
                  <td><%= adj.created_at.strftime("%d/%m/%Y %H:%M") %></td>
                  <td><%= adj.user&.full_name || "—" %></td>
                  <td class="text-end"><%= adj.paid_used_delta.to_f.zero? ? "—" : fmt.call(adj.paid_used_delta) %></td>
                  <td class="text-end"><%= adj.free_used_delta.to_f.zero? ? "—" : fmt.call(adj.free_used_delta) %></td>
                  <td class="text-end"><%= adj.paid_bonus_delta.to_f.zero? ? "—" : fmt.call(adj.paid_bonus_delta) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted mb-0">No adjustments recorded for this service.</p>
      <% end %>
    </div>
  </div>

  <!-- Sessions Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>Duration</th>
          <th>Presence</th>
          <th>Type</th>
          <th>Confirmed</th>
          <th>Note</th>
          <th>Created at</th>
        </tr>
      </thead>
      <tbody>
        <% @sessions.each do |s| %>
          <tr>
            <td><%= s.date&.strftime("%d/%m/%Y") || "—" %></td>
            <td><%= s.time&.strftime("%H:%M") || "—" %></td>
            <td><%= s.duration_display %></td>
            <td><%= s.present? ? "Présent·e" : "Absent·e" %></td>
            <td><%= s.session_type.to_s.capitalize %></td>
            <td>
              <% if s.confirmed? %>
                <span class="badge bg-success">Yes</span>
              <% else %>
                <span class="badge bg-warning text-dark">No</span>
              <% end %>
            </td>
            <td><%= s.note.presence || "—" %></td>
            <td><%= s.created_at.strftime("%d/%m/%Y %H:%M") %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end">
    <%== pagy_bootstrap_nav(@pagy) %>
  </div>
</div>
