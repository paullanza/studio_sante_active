<div class="container mt-4">
  <h1>Fliip Users</h1>

  <div class="row justify-content-center">
    <div class="col-sm-8 my-3">
      <%= form_with url: fliip_users_path, method: :get, class: "d-flex gap-2", local: true do %>
        <%= text_field_tag :query,
              params[:query],
              class: "form-control",
              placeholder: "Search by name, email, or ID…" %>
        <%= submit_tag "Search", name: "", class: "btn btn-primary" %>
        <% if params[:query].present? %>
          <%= link_to "Clear", fliip_users_path, class: "btn btn-outline-secondary" %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="text-muted small">
      Page <%= @pagy.page %> of <%= @pagy.pages %> — <%= @pagy.count %> clients
    </div>
    <div><%== pagy_bootstrap_nav(@pagy) %></div>
  </div>

  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Remote ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Active Contracts</th>
        <th>Active Services</th>
        <th style="min-width:260px;">Most Recent Service — Progress</th>
      </tr>
    </thead>
    <tbody>
      <% active_codes = %w[A S P] %>

      <% @fliip_users.each do |user| %>
        <% active_contracts_count = user.fliip_contracts.count { |c| active_codes.include?(c.status.to_s) } %>
        <% active_services_count  = user.fliip_services.count  { |s| active_codes.include?(s.purchase_status.to_s) } %>
        <% svc = @recent_services_by_user_id[user.id] %>

        <tr>
          <td><%= user.id %></td>
          <td><%= user.remote_id %></td>
          <td>
            <%= link_to "#{user.user_firstname} #{user.user_lastname}",
                        fliip_user_path(user),
                        class: "text-decoration-none" %>
          </td>
          <td><%= user.user_email.presence || "—" %></td>
          <td><span class="badge bg-primary"><%= active_contracts_count %></span></td>
          <td><span class="badge bg-success"><%= active_services_count %></span></td>

          <td>
            <% if svc.present? %>
              <% fmt = ->(n) { ('%.1f' % n.to_f) } %>
              <% paid_label  = paid_usage_label(svc, @usage_sums) %>
              <% paid_pct    = paid_usage_percent(svc, @usage_sums) %>
              <% free_used   = fmt.call((@usage_sums[[svc.id, "free"]] || 0.0)) %>
              <% free_total  = svc.service_definition&.free_sessions %>
              <% free_total_s = free_total.nil? ? "—" : free_total.to_s %>

              <div class="small mb-1">
                <strong><%= svc.service_name.presence || "Service" %></strong>
                <% if svc.expire_date.present? %>
                  <span class="text-muted"> • ends <%= svc.expire_date.strftime("%d/%m/%Y") %></span>
                <% end %>
              </div>

              <!-- Time progress -->
              <div class="mb-2">
                <div class="d-flex justify-content-between small">
                  <span>Time</span>
                  <span><%= time_range_label(svc) %> • <%= time_progress_percent(svc) %>%</span>
                </div>
                <div class="progress" role="progressbar"
                     aria-label="Time progress" aria-valuemin="0" aria-valuemax="100"
                     aria-valuenow="<%= time_progress_percent(svc) %>">
                  <div class="progress-bar bg-info"
                       style="width: <%= time_progress_percent(svc) %>%"></div>
                </div>
              </div>

              <!-- Sessions (paid bar) + free usage bracket -->
              <div>
                <div class="d-flex justify-content-between small">
                  <span>Sessions</span>
                  <span>
                    <%= paid_label %> • <%= paid_pct %>%
                    <span class="ms-2 text-muted">[<%= free_used %>/<%= free_total_s %> absences]</span>
                  </span>
                </div>
                <div class="progress" role="progressbar"
                     aria-label="Paid sessions usage" aria-valuemin="0" aria-valuemax="100"
                     aria-valuenow="<%= paid_pct %>">
                  <div class="progress-bar bg-success"
                       style="width: <%= paid_pct %>%"></div>
                </div>
              </div>
            <% else %>
              <span class="text-muted">—</span>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div class="d-flex justify-content-end">
    <%== pagy_bootstrap_nav(@pagy) %>
  </div>
</div>
