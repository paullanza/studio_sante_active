<div class="container mt-4">
  <h1>Fliip Users</h1>

  <div class="row justify-content-center">
    <div class="col-sm-8 my-3">
      <%= form_with url: fliip_users_path, method: :get, class: "d-flex gap-2", local: true do %>
        <%= text_field_tag :query, params[:query], class: "form-control", placeholder: "Search by name, email, or ID…" %>
        <%= submit_tag "Search", name: "", class: "btn btn-primary" %>
        <% if params[:query].present? %>
          <%= link_to "Clear", fliip_users_path, class: "btn btn-outline-secondary" %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="text-muted small">
      Page <%= @pagy.page %> of <%= @pagy.pages %> — <%= @pagy.count %> clients
    </div>
    <div><%== pagy_bootstrap_nav(@pagy) %></div>
  </div>

  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Remote ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Member Since</th>
        <th style="min-width:260px;">Most Recent Service</th>
      </tr>
    </thead>
    <tbody>
      <% @fliip_users.each do |user| %>
        <% svc = @recent_services_by_user_id[user.id] %>

        <!-- ROW 1: main info -->
        <tr>
          <td><%= user.id %></td>
          <td><%= user.remote_id %></td>
          <td>
            <%= link_to "#{user.user_firstname} #{user.user_lastname}",
                        fliip_user_path(user),
                        class: "text-decoration-none" %>
          </td>
          <td><%= user.user_email.presence || "—" %></td>
          <td class="text-nowrap">
            <%= user.member_since ? user.member_since.strftime("%d/%m/%Y") : "—" %>
          </td>
          <td>
            <% if svc.present? %>
              <div class="small">
                <strong>
                  <%= link_to (svc.service_name.presence || "Service"), fliip_service_path(svc), class: "text-decoration-none" %>
                </strong>
                <% if svc.expire_date.present? %>
                  <span class="text-muted"> • ends <%= svc.expire_date.strftime("%d/%m/%Y") %></span>
                <% end %>
              </div>
            <% else %>
              <span class="text-muted">—</span>
            <% end %>
          </td>
        </tr>

        <%# ROW 2: progress bars under the whole row (two halves) %>
        <% if svc.present? %>
          <tr class="align-middle bar-row">
            <%# Left half: Time progress %>
            <td colspan="3">
              <% time_pct = svc.time_progress_percent || 0 %>
              <%= bar_with_label(
                    percent: time_pct,
                    label:   "#{svc.time_range_label} • #{time_pct}%"
                  ) %>
            </td>

            <%# Right half: Sessions progress %>
            <td colspan="3">
              <% paid_pct = svc.paid_progress_percent || 0 %>
              <%= bar_with_label(
                    percent: paid_pct,
                    label:   "#{svc.paid_usage_compact_str} #{svc.absences_compact_str} • #{paid_pct}%"
                  ) %>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>

  <div class="d-flex justify-content-end">
    <%== pagy_bootstrap_nav(@pagy) %>
  </div>
</div>
