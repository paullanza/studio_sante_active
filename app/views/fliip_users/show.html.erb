<div class="container my-4 fliip-user-show">
  <%# local helpers %>
  <% full_name     = [@fliip_user.user_firstname, @fliip_user.user_lastname].compact_blank.join(" ") %>
  <% full_address  = [@fliip_user.user_address, @fliip_user.user_city, @fliip_user.user_zipcode].compact_blank.join(", ") %>
  <% primary_phone = @fliip_user.user_phone1.presence %>
  <% email         = @fliip_user.user_email.presence %>
  <% gender        = @fliip_user.user_gender.presence %>
  <% status        = @fliip_user.user_status.presence %>
  <% member_since  = @fliip_user.member_since&.strftime("%d/%m/%Y") %>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0 fw-bold"><%= full_name.presence || "—" %></h1>
    <div class="d-flex gap-2">
      <%= button_to "⟳ Rafraîchir depuis l’API",
                    refresh_fliip_user_path(@fliip_user.remote_id),
                    method: :post,
                    form_class: "d-inline",
                    class: "btn btn-outline-secondary btn-sm",
                    data: { turbo: false } %>
      <%= link_to "← Retour à la liste", fliip_users_path, class: "btn btn-secondary btn-sm" %>
    </div>
  </div>

  <div class="row g-4">
    <!-- LEFT: Compact profile (unchanged) -->
    <div class="col-12 col-lg-3">
      <div class="card shadow-sm stretch-card">
        <div class="card-body p-3 text-center">
          <% if @fliip_user.user_image.present? %>
            <%= image_tag @fliip_user.user_image, class: "img-thumbnail rounded-circle mb-2", style: "max-width:100px;" %>
          <% else %>
            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width:100px;height:100px;">
              <span class="text-muted fs-3">👤</span>
            </div>
          <% end %>

          <div class="fw-semibold"><%= full_name.presence || "—" %></div>
          <div class="small text-muted">ID: <%= @fliip_user.id %></div>
          <div class="small text-muted mb-3">RemoteID: <%= @fliip_user.remote_id || "—" %></div>

          <div class="text-start">
            <div class="mb-2">
              <div class="text-muted small">Genre</div>
              <div><%= gender || "–" %></div>
            </div>

            <div class="mb-2">
              <div class="text-muted small">Statut</div>
              <div><span class="badge bg-light text-dark"><%= status || "–" %></span></div>
            </div>

            <div class="mb-2">
              <div class="text-muted small">Membre depuis</div>
              <div><%= member_since || "–" %></div>
            </div>

            <div class="mb-2">
              <div class="text-muted small">Courriel</div>
              <div><%= email ? mail_to(email) : "–" %></div>
            </div>

            <div class="mb-2">
              <div class="text-muted small">Téléphone</div>
              <div><%= primary_phone ? link_to(primary_phone, "tel:#{primary_phone}") : "–" %></div>
            </div>

            <div class="">
              <div class="text-muted small">Adresse</div>
              <div><%= full_address.presence || "–" %></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Tabs header + Card with tab content -->
    <div class="col-12 col-lg-9">
      <div class="tab-header" data-controller="tabs">
        <nav>
          <div class="nav nav-tabs" id="client-tablist" role="tablist">
            <button
              class="nav-link active"
              id="tab-client-services"
              type="button"
              role="tab"
              aria-controls="pane-client-services"
              aria-selected="true"
              data-bs-target="#pane-client-services"
              data-action="click->tabs#activate">
              Services
            </button>

            <button
              class="nav-link"
              id="tab-client-contracts"
              type="button"
              role="tab"
              aria-controls="pane-client-contracts"
              aria-selected="false"
              data-bs-target="#pane-client-contracts"
              data-action="click->tabs#activate">
              Abonnements
            </button>
          </div>
        </nav>

        <div class="card shadow-sm stretch-card">
          <div class="card-body p-3 scrollable-card-body">
            <div id="client-tabcontent">
              <!-- Services (default) -->
              <section id="pane-client-services" role="tabpanel" aria-labelledby="tab-client-services">
                <% if @fliip_user.fliip_services.any? %>
                  <div class="table-scroll">
                    <%= render "fliip_services/shared/services_table",
                          services: @fliip_user.fliip_services.order(expire_date: :desc) %>
                  </div>
                <% else %>
                  <p class="text-muted small mb-2">Aucun service trouvé pour cet·te utilisateur·trice.</p>
                <% end %>
              </section>

              <!-- Abonnements -->
              <section class="d-none" id="pane-client-contracts" role="tabpanel" aria-labelledby="tab-client-contracts">
                <% if @fliip_user.fliip_contracts.any? %>
                  <div class="table-scroll">
                    <% fmt_date = ->(d) { d.present? ? d.strftime("%d/%m/%Y") : "—" } %>
                    <% status_badge = ->(code) do
                         case code.to_s.strip.upcase
                         when "A" then ["Actif",     "bg-success"]
                         when "I" then ["Inactif",   "bg-secondary"]
                         when "C" then ["Annulé",    "bg-danger"]
                         when "S" then ["Suspendu",  "bg-warning text-dark"]
                         when "P" then ["Planifié",  "bg-info text-dark"]
                         else           ["—",        "bg-secondary"]
                         end
                       end %>
                    <table class="table table-hover align-middle">
                      <thead class="table-light">
                        <tr>
                          <th class="text-nowrap">Abonnement #</th>
                          <th class="text-nowrap">Statut</th>
                          <th class="text-nowrap">Début</th>
                          <th class="text-nowrap">Fin</th>
                          <th class="text-nowrap">Abonnement</th>
                          <th class="text-nowrap">Durée</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% @fliip_user.fliip_contracts.order(end_date: :desc).each do |c| %>
                          <% label, color = status_badge.call(c.status) %>
                          <tr>
                            <td class="text-nowrap"><%= c.remote_contract_id || "—" %></td>
                            <td class="text-nowrap"><span class="badge <%= color %>"><%= label %></span></td>
                            <td class="text-nowrap">
                              <div><%= fmt_date.call(c.start_date) %></div>
                              <% if c.stop_date.present? %>
                                <div class="text-muted small">Suspendu le : <%= fmt_date.call(c.stop_date) %></div>
                              <% end %>
                            </td>
                            <td class="text-nowrap">
                              <div><%= fmt_date.call(c.end_date) %></div>
                              <% if c.cancel_date.present? %>
                                <div class="text-muted small">Annulé le : <%= fmt_date.call(c.cancel_date) %></div>
                              <% end %>
                            </td>
                            <td class="text-wrap">
                              <%= c.membership_name.presence || "—" %>
                            </td>
                            <td class="text-nowrap"><%= c.duration.presence || "—" %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                <% else %>
                  <p class="text-muted small mb-2">Aucun abonnement trouvé pour cet·te utilisateur·trice.</p>
                <% end %>
              </section>
            </div>
          </div>
        </div>
      </div><!-- /tabs controller scope -->
    </div>
  </div>
</div>
