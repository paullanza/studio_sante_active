<div class="container mt-4">
  <h1>
    Fliip User
    <small class="text-muted">#<%= @fliip_user.remote_id %></small>
    <%= button_to "⟳ Refresh from API",
                  refresh_fliip_user_path(@fliip_user.remote_id),
                  method: :post,
                  form_class: "d-inline",
                  class: "btn btn-sm btn-outline-secondary ms-2",
                  data: { turbo: false } %>
  </h1>

  <h2 class="mt-4">Attributes</h2>
  <table class="table table-bordered table-sm">
    <tbody>
      <tr>
        <td colspan="2" class="text-center">
          <%= image_tag @fliip_user.user_image if @fliip_user.user_image.present? %>
        </td>
      </tr>
      <% @fliip_user.attributes.each do |attr, value| %>
        <tr>
          <th class="text-capitalize"><%= attr.titleize %></th>
          <td><%= value.presence || "–" %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <h2 class="mt-4">Contracts</h2>
  <% if @fliip_user.fliip_contracts.any? %>
    <div class="table-responsive">
      <table class="table table-bordered table-sm">
        <thead class="thead-light">
          <tr>
            <th>Contract #</th>
            <th>Status</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Stop Date</th>
            <th>Resume Date</th>
            <th>Cancel Date</th>
            <th>Membership Name</th>
            <th>Plan Description</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody>
          <% @fliip_user.fliip_contracts.each do |contract| %>
            <tr>
              <td><%= contract.remote_contract_id %></td>
              <td><%= contract.status.presence || "–" %></td>
              <td><%= contract.start_date || "–" %></td>
              <td><%= contract.end_date   || "–" %></td>
              <td><%= contract.stop_date  || "–" %></td>
              <td><%= contract.resume_date || "–" %></td>
              <td><%= contract.cancel_date || "–" %></td>
              <td><%= contract.membership_name.presence || "–" %></td>
              <td><%= contract.plan_description.presence || "–" %></td>
              <td><%= contract.duration.presence || "–" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-muted">No contracts found for this user.</p>
  <% end %>

  <h2 class="mt-4">Services</h2>
  <% if @fliip_user.fliip_services.any? %>
    <div class="table-responsive">
      <table class="table table-bordered table-sm">
        <thead class="thead-light">
          <tr>
            <th>Purchase #</th>
            <th>Status</th>
            <th>Start Date</th>
            <th>Expire Date</th>
            <th>Purchase Date</th>
            <th>Stop Date</th>
            <th>Cancel Date</th>
            <th>Service ID</th>
            <th>Service Name</th>
            <th>Duration</th>
            <th>Description</th>
            <th>Progress</th>
          </tr>
        </thead>
        <tbody>
          <% @fliip_user.fliip_services.each do |svc| %>
            <%# helpers: time_range_label, time_progress_percent, paid_usage_label, paid_usage_percent %>
            <% fmt = ->(n) { ('%.1f' % n.to_f) } %>
            <% free_used  = fmt.call((@usage_sums[[svc.id, "free"]] || 0.0)) %>
            <% free_total = svc.service_definition&.free_sessions %>
            <% free_total_s = free_total.nil? ? "—" : free_total.to_s %>

            <tr>
              <td><%= svc.remote_purchase_id %></td>
              <td><%= svc.purchase_status.presence || "–" %></td>
              <td><%= svc.start_date || "–" %></td>
              <td><%= svc.expire_date || "–" %></td>
              <td><%= svc.purchase_date || "–" %></td>
              <td><%= svc.stop_date || "–" %></td>
              <td><%= svc.cancel_date || "–" %></td>
              <td><%= svc.service_id %></td>
              <td>
                <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                            fliip_service_path(svc),
                            class: "text-decoration-none" %>
              </td>
              <td><%= svc.duration.presence || "–" %></td>
              <td><%= svc.service_description.presence || "–" %></td>

              <td style="min-width: 260px;">
                <!-- Time progress -->
                <div class="mb-2">
                  <div class="d-flex justify-content-between small">
                    <span>Time</span>
                    <span><%= time_range_label(svc) %> • <%= time_progress_percent(svc) %>%</span>
                  </div>
                  <div class="progress" role="progressbar"
                       aria-label="Time progress"
                       aria-valuemin="0" aria-valuemax="100"
                       aria-valuenow="<%= time_progress_percent(svc) %>">
                    <div class="progress-bar bg-info"
                         style="width: <%= time_progress_percent(svc) %>%"></div>
                  </div>
                </div>

                <!-- Sessions (paid bar) + free usage bracket -->
                <div>
                  <div class="d-flex justify-content-between small">
                    <span>Sessions</span>
                    <span>
                      <%= paid_usage_label(svc, @usage_sums) %> •
                      <%= paid_usage_percent(svc, @usage_sums) %>%
                      <span class="ms-2 text-muted">[<%= free_used %>/<%= free_total_s %> absences]</span>
                    </span>
                  </div>
                  <div class="progress" role="progressbar"
                       aria-label="Paid sessions usage"
                       aria-valuemin="0" aria-valuemax="100"
                       aria-valuenow="<%= paid_usage_percent(svc, @usage_sums) %>">
                    <div class="progress-bar bg-success"
                         style="width: <%= paid_usage_percent(svc, @usage_sums) %>%"></div>
                  </div>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-muted">No services found for this user.</p>
  <% end %>

  <%= link_to "← Back to list", fliip_users_path, class: "btn btn-secondary mt-3" %>
</div>
