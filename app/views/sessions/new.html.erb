<div class="container mt-4" data-controller="filter-services">
  <h1 class="mb-4">New Session</h1>

  <%= form_with(model: @session, local: true) do |f| %>
    <div class="mb-3 d-flex gap-3 align-items-end flex-wrap">
      <div class="flex-fill">
        <%= f.label :fliip_user_id, "Client" %>
        <%= f.select :fliip_user_id,
                     options_from_collection_for_select(@fliip_users, :id, ->(u) { "#{u.user_lastname.strip}, #{u.user_firstname.strip}" }),
                     { include_blank: "Select a client" },
                     class: "form-select",
                     data: {
                       filter_services_target: "userSelect",
                       action: "change->filter-services#onUserChange"
                     } %>
      </div>

      <div class="flex-fill">
        <%= f.label :fliip_service_id, "Service" %>
        <select name="session[fliip_service_id]"
                class="form-select"
                disabled
                data-filter-services-target="serviceSelect">
          <option value="">Select a client first</option>
        </select>
      </div>

      <div class="form-check mt-4">
        <%= f.check_box :present, class: "form-check-input", id: "session_present" %>
        <%= f.label :present, "Présent", class: "form-check-label", for: "session_present" %>
      </div>

      <!-- Top-level (not nested) half-hour checkbox -->
      <div class="form-check mt-4">
        <input type="checkbox"
               name="half_hour"
               id="half_hour"
               value="1"
               class="form-check-input">
        <label for="half_hour" class="form-check-label">Half Hour (30 min)</label>
      </div>
    </div>

    <div class="mb-3 d-flex gap-3">
      <div class="flex-fill">
        <%= f.label :date %>
        <%= f.date_field :date, value: Date.today, class: "form-control" %>
      </div>

      <div class="flex-fill">
        <%= f.label :time %>
        <%= f.select :time,
                     options_for_select(
                       (6..20).flat_map { |h| ["%02d:00" % h, "%02d:30" % h] },
                       Time.current.strftime("%H:%M")
                     ),
                     {},
                     class: "form-select" %>
      </div>
    </div>

    <div class="mb-3">
      <%= f.label :note %>
      <%= f.text_area :note, class: "form-control", rows: 3 %>
    </div>

    <%= f.submit "Create Session", class: "btn btn-primary" %>
  <% end %>

  <hr>

  <!-- Services table (populated after a client is selected) -->
  <div class="mt-3">
    <h2 class="mb-3">Client Services</h2>

    <div data-filter-services-target="status" class="text-muted small mb-2" hidden>
      Loading services…
    </div>
    <div data-filter-services-target="error" class="alert alert-danger py-2 px-3" hidden></div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Service</th>
            <th>Start</th>
            <th>End</th>
            <th>Status</th>
            <th>Paid (used/total)</th>
            <th>Free (used/total)</th>
          </tr>
        </thead>
        <tbody data-filter-services-target="servicesTbody">
          <tr data-filter-services-target="emptyRow" class="text-muted">
            <td colspan="6">Select a client to view services.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <hr>
  <h2>Unconfirmed Sessions</h2>

  <% if current_user.sessions.unconfirmed.any? %>
    <table class="table table-bordered table-striped mt-3">
      <thead class="table-light">
        <tr>
          <th>Client</th>
          <th>Service</th>
          <th>Date</th>
          <th>Time</th>
          <th>Duration</th>
          <th>Présence</th>
          <th>Type</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody>
        <% current_user.sessions.unconfirmed.each do |session| %>
          <tr>
            <td><%= session.fliip_user.user_firstname %> <%= session.fliip_user.user_lastname %></td>
            <td><%= session.fliip_service.service_name %></td>
            <td><%= session.date&.strftime("%d/%m/%Y") || "—" %></td>
            <td><%= session.time&.strftime("%H:%M") || "—" %></td>
            <td><%= session.duration_display %></td>
            <td><%= session.present? ? "Présent·e" : "Absent·e" %></td>
            <td><%= session.session_type.capitalize %></td>
            <td><%= session.note.presence || "—" %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-muted">No unconfirmed sessions.</p>
  <% end %>

  <div id="session-stats" class="mt-4"></div>
</div>
