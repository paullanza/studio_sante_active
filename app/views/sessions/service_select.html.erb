<%= turbo_frame_tag "service_select" do %>
  <label class="form-label">Service</label>

  <% if @services.present? %>
    <select name="session[fliip_service_id]"
            id="session_fliip_service_id"
            class="form-select form-select-sm"
            required
            data-session-form-target="service"
            data-action="change->session-form#recheck">
      <option value="">Sélectionne un service</option>

      <% today        = Date.current
         future_limit = today + 1.month
         past_limit   = today - 1.month %>

      <% @services.each do |svc| %>
        <% starts_too_late = svc.start_date.present?  && svc.start_date  > future_limit
           ended_too_long  = svc.expire_date.present? && svc.expire_date < past_limit
           cancelled       = (svc.purchase_status == "C")
           used_up         = !svc.can_book_session?

           disabled = (starts_too_late || ended_too_long || cancelled || used_up)

           reason =
             if cancelled
               "Annulé"
             elsif starts_too_late
               "Commence dans plus d’un mois"
             elsif ended_too_long
               "Terminé il y a plus d’un mois"
             elsif used_up
               "Toutes les séances utilisées"
             end

           prefix = svc.remote_purchase_id.present? ? "##{svc.remote_purchase_id} " : ""
           label  = prefix + (svc.service_name.presence || "Service ##{svc.id}")
           label += " (se termine le #{svc.expire_date.strftime('%d/%m/%Y')})" if svc.expire_date.present?
        %>

        <option
          value="<%= svc.id %>"
          <%= "selected" if @selected_id.present? && svc.id == @selected_id.to_i %>
          <%= "disabled" if disabled %>
          <%= %(title="#{reason}") if disabled %>
          data-has-def="<%= svc.service_definition.present? %>"
          data-free-remaining="<%= svc.remaining_free_sessions.to_f %>">
          <%= label %>
        </option>
      <% end %>
    </select>
  <% else %>
    <select class="form-select" disabled>
      <option>Sélectionne un·e client·e d’abord</option>
    </select>
  <% end %>
<% end %>
