<% s = session %>

<tr id="<%= dom_id(s) %>"
    data-controller="session-row"
    data-session-row-id-value="<%= s.id %>"
    data-session-row-show-bulk-value="<%= local_assigns[:show_bulk_checkbox] %>"
    data-session-row-edit-url-value="<%= edit_session_path(s) %>"
    data-session-row-row-url-value="<%= row_session_path(s) %>"
    data-session-row-update-url-value="<%= session_path(s) %>">

  <%# 1) Optional bulk checkbox (empty cell to preserve columns) %>
  <% if local_assigns[:show_bulk_checkbox] %>
    <td></td>
  <% end %>

  <%# 2) Session number (readonly) %>
  <td class="text-center align-middle">
    <% if s.sequence_label.present? %>
      <span class="badge <%= s.presence_badge_variant %>"><%= s.sequence_label %></span>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 3) Client + Service combined (readonly) %>
  <td class="align-middle">
    <% if s.fliip_user %>
      <div class="text-truncate">
        <%= link_to s.fliip_user.full_name, fliip_user_path(s.fliip_user), class: "text-decoration-none" %>
      </div>
      <div class="text-muted small text-truncate">
        FliipUserID: <%= s.fliip_user.id %> • RemoteID: <%= s.fliip_user.remote_id %>
      </div>
    <% else %>
      <div class="text-muted">—</div>
    <% end %>

    <% if (svc = s.fliip_service) %>
      <div class="text-truncate mt-1">
        <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                    fliip_service_path(svc),
                    class: "text-decoration-none" %>
      </div>
      <div class="text-muted small text-truncate">
        Svc#: <%= svc.id %> • Purch#: <%= svc.remote_purchase_id %> • DefID: <%= (svc.service_definition&.service_id || svc.service_id) %>
      </div>
    <% else %>
      <div class="text-muted">—</div>
    <% end %>
  </td>

  <%# 4-6) EDIT FORM merged into one big cell %>
  <td class="small align-middle" colspan="3">
    <div class="row g-2 align-items-center" data-controller="flatpickr">
      <div class="col-auto">
        <%= label_tag :session_date, "Date", class: "form-label small mb-0" %>
        <%= text_field_tag "session[date]",
                          (s.occurred_at&.to_date&.strftime("%Y-%m-%d") || Date.current.strftime("%Y-%m-%d")),
                          class: "form-control form-control-sm",
                          placeholder: "YYYY-MM-DD",
                          data: { flatpickr_target: "date" } %>
      </div>

      <div class="col-auto">
        <%= label_tag :session_time, "Heure", class: "form-label small mb-0" %>
        <%= text_field_tag "session[time]",
                          (s.occurred_at&.strftime("%H:%M") || (defined?(default_time_slot_str) ? default_time_slot_str : "08:00")),
                          class: "form-control form-control-sm",
                          step: 900,
                          inputmode: "numeric",
                          placeholder: "HH:MM",
                          data: { flatpickr_target: "time" } %>
      </div>

      <div class="col-auto">
        <%= label_tag :session_present, "Présent", class: "form-label small mb-0 d-block" %>
        <div class="form-check mt-1">
          <%= check_box_tag "session[present]", "1", s.present?, class: "form-check-input", id: "session_present_#{s.id}" %>
          <%= label_tag "session_present_#{s.id}", "Oui", class: "form-check-label small" %>
        </div>
      </div>

      <div class="col-auto">
        <%= label_tag :half_hour, "Durée", class: "form-label small mb-0 d-block" %>
        <div class="form-check mt-1">
          <%= check_box_tag "half_hour", "1", (s.duration.to_f == 0.5), class: "form-check-input", id: "half_hour_#{s.id}" %>
          <%= label_tag "half_hour_#{s.id}", "30 min (décoché = 60)", class: "form-check-label small" %>
        </div>
      </div>

      <% if current_user.admin? || current_user.super_admin? %>
        <div class="col-auto">
          <label class="form-label small mb-0 d-block">Employé·e</label>
          <select name="session[user_id]" class="form-select form-select-sm">
            <% @staff.each do |u| %>
              <option value="<%= u.id %>" <%= "selected" if u.id == s.user_id %>><%= u.full_name %></option>
            <% end %>
          </select>
          <% if s.created_by_id.present? && s.created_by_id != s.user_id %>
            <div class="small text-muted mt-1">créé par <%= s.created_by&.full_name %></div>
          <% end %>
        </div>
      <% end %>
    </div>
  </td>

  <%# 7) Actions %>
  <td class="text-end align-middle text-nowrap">
    <a  href="<%= row_session_path(s) %>"
        class="btn btn-sm btn-outline-secondary me-1"
        data-action="session-row#cancel">
      Annuler
    </a>
    <button type="button"
            class="btn btn-sm btn-primary"
            data-action="session-row#save">
      Enregistrer
    </button>
  </td>
</tr>

<tr class="note-row" id="<%= dom_id(s, :note) %>">
  <td colspan="<%= (local_assigns[:show_bulk_checkbox] ? 7 : 6) %>" class="py-1">
    <div class="small">
      <strong>Note :</strong>
      <textarea name="session[note]" rows="1" class="form-control form-control-sm d-inline-block mt-1"><%= s.note %></textarea>
    </div>
  </td>
</tr>
