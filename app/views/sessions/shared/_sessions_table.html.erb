<%# Locals:
#   sessions: REQUIRED
#   show_bulk_checkbox: default false
#   scope_name: e.g., :unconfirmed (kept for compatibility)
#   compact: default true
%>

<div class="table-responsive" data-controller="select-all">
  <table class="table table-striped table-bordered align-middle compact-bars">
    <thead class="table-light">
      <tr>
        <% if local_assigns[:show_bulk_checkbox] %>
          <th class="text-center">
            <input type="checkbox"
                   class="form-check-input m-0"
                   data-action="select-all#toggleAll"
                   data-select-all-target="checkbox">
          </th>
        <% end %>

        <!-- Session number first (after checkbox) -->
        <th class="text-center text-nowrap">Séance #</th>

        <!-- Wider date/presence column -->
        <th class="text-nowrap w-50">Date · Présence</th>

        <!-- Thinner client/service columns -->
        <th class="text-nowrap w-25">Client·e</th>
        <th class="text-nowrap w-25">Service</th>

        <th class="text-nowrap text-center">Employé·e</th>
        <th class="text-center text-nowrap">Actions</th>
      </tr>
    </thead>

    <tbody>
      <% if sessions.any? %>
        <% sessions.each do |s| %>
          <%= render "sessions/shared/session_row",
                     session: s,
                     show_bulk_checkbox: local_assigns[:show_bulk_checkbox] %>
        <% end %>
      <% else %>
        <tr>
          <td colspan="<%= local_assigns[:show_bulk_checkbox] ? 7 : 6 %>" class="text-muted">Aucune séance à afficher.</td>
        </tr>
      <% end %>

      <% if local_assigns[:show_adjustment] && @service&.service_usage_adjustments %>
        <% service = local_assigns[:fliip_service] %>
        <% if service.present? %>
          <% paid_from_adjustments  = service.paid_used_adjustment.to_f %>
          <% free_from_adjustments  = service.free_used_adjustment.to_f %>
          <% bonus_from_adjustments = service.bonus_sessions_total.to_f %>

          <tr class="table-light">
            <td colspan="<%= local_assigns[:show_bulk_checkbox] ? 7 : 6 %>">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Ajustements</strong> —
                  <span>
                    <%= format('%.1f', free_from_adjustments) %> séance(s) gratuite(s)
                    et <%= format('%.1f', paid_from_adjustments) %> séance(s) payante(s)
                    ont été comptabilisées par des ajustements.
                  </span>
                </div>
                <% if bonus_from_adjustments.nonzero? %>
                  <div class="text-muted small">
                    Bonus accordé(s) : <%= format('%.1f', bonus_from_adjustments) %>
                  </div>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>
