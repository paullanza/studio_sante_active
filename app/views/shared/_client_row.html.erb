<%# Expects:
#   user: FliipUser (collection item)
#   recent_services_by_user_id: Hash{Integer => (FliipService|FliipContract|nil)}
%>
<% item = recent_services_by_user_id[user.id] %>

<tr>
  <!-- Client (avatar, name link, IDs stacked) -->
  <td class="align-middle">
    <div class="d-flex align-items-center">
      <!-- Avatar -->
      <div class="me-2 flex-shrink-0">
        <% if user.user_image.present? %>
          <%= image_tag user.user_image,
                        alt: "#{user.user_firstname} #{user.user_lastname}",
                        class: "rounded-circle avatar-xs",
                        width: 24, height: 24,
                        loading: "lazy", referrerpolicy: "no-referrer" %>
        <% else %>
          <!-- Minimal fallback circle with initials -->
          <div class="rounded-circle bg-light border d-flex align-items-center justify-content-center avatar-xs text-muted fw-semibold" style="width:24px;height:24px;font-size:11px;line-height:1;">
            <%= "#{user.user_firstname.to_s.first}#{user.user_lastname.to_s.first}".upcase.presence || "?" %>
          </div>
        <% end %>
      </div>

      <!-- Name + IDs -->
      <div class="min-w-0">
        <div class="text-nowrap text-truncate">
          <%= link_to "#{user.user_firstname} #{user.user_lastname}",
                      fliip_user_path(user),
                      class: "text-decoration-none fw-semibold" %>
        </div>
        <div class="small text-muted lh-1 text-nowrap">
          <!-- IDs stacked under name -->
          UserID: <%= user.id %> • RemoteID: <%= user.remote_id %>
        </div>
      </div>
    </div>
  </td>

  <!-- Contact (email + phone stacked) -->
  <td class="align-middle">
    <div class="text-truncate">
      <%= user.user_email.presence || "—" %>
    </div>
    <div class="small text-muted lh-1 text-truncate">
      <%= [user.user_phone1, user.user_phone2].compact_blank.first.presence || "—" %>
    </div>
  </td>

  <!-- Member Since -->
  <td class="text-nowrap align-middle">
    <%= user.member_since ? user.member_since.strftime("%d/%m/%Y") : "—" %>
  </td>

  <!-- Most Recent Service OR Active Contract -->
  <td class="align-middle">
    <% if item.is_a?(FliipService) %>
      <% svc = item %>
      <% badge_class = purchase_status_badge_class(svc.purchase_status) %>

      <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="badge <%= badge_class %>"><%= svc.status_name %></span>
        <strong>
          <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                      fliip_service_path(svc),
                      class: "text-decoration-none" %>
        </strong>
      </div>

      <div class="text-muted small lh-1 mt-1">
        Svc#: <%= svc.id %>
        <span class="mx-1">•</span>
        Purch#: <%= svc.remote_purchase_id || "—" %>
        <span class="mx-1">•</span>
        Duration: <%= svc.duration.presence || "—" %>
        <% if svc.expire_date.present? %>
          <span class="mx-1">•</span>
          Ends: <%= svc.expire_date.strftime("%d/%m/%Y") %>
        <% end %>
      </div>

    <% elsif item.is_a?(FliipContract) %>
      <% contract = item %>
      <% contract_badge =
           case contract.status
           when "A" then "badge bg-success"
           when "S" then "badge bg-warning text-dark"
           when "C" then "badge bg-danger"
           else           "badge bg-secondary"
           end %>

      <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="<%= contract_badge %>"><%= contract.status_name %></span>
        <strong>
          <%= link_to (contract.membership_name.presence || "Contract ##{contract.id}"),
                      fliip_user_path(user),
                      class: "text-decoration-none" %>
        </strong>
      </div>

      <div class="text-muted small lh-1 mt-1">
        Contract#: <%= contract.id %>
        <% if contract.start_date.present? %>
          <span class="mx-1">•</span>
          Start: <%= contract.start_date.strftime("%d/%m/%Y") %>
        <% end %>
        <% if contract.end_date.present? %>
          <span class="mx-1">•</span>
          Ends: <%= contract.end_date.strftime("%d/%m/%Y") %>
        <% end %>
      </div>

    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <!-- Progress (only for services) -->
  <td class="align-middle" style="width:18%;">
    <% if item.is_a?(FliipService) %>
      <% time_pct = item.time_progress_percent || 0 %>
      <% paid_pct = item.paid_progress_percent || 0 %>

      <%= bar_with_label(
            percent: time_pct,
            label:   "#{item.time_range_label} • #{time_pct}%",
            bg_class: progress_base_color(time_pct)
          ) %>

      <div class="mt-1">
        <%= bar_with_label(
              percent: paid_pct,
              label:   "#{item.paid_usage_compact_str} #{item.absences_compact_str} • #{paid_pct}%",
              bg_class: progress_usage_color(paid_pct, time_pct)
            ) %>
      </div>
    <% else %>
      <span class="text-muted small">—</span>
    <% end %>
  </td>
</tr>
