<%# Expects:
#   user: FliipUser (collection item)
#   recent_services_by_user_id: Hash{Integer => FliipService or nil}
%>
<% svc = recent_services_by_user_id[user.id] %>

<tr>
  <td><%= user.id %></td>
  <td><%= user.remote_id %></td>

  <td class="text-nowrap">
    <%= link_to "#{user.user_firstname} #{user.user_lastname}",
                fliip_user_path(user),
                class: "text-decoration-none" %>
  </td>

  <td><%= user.user_email.presence || "—" %></td>

  <td class="text-nowrap">
    <%= user.member_since ? user.member_since.strftime("%d/%m/%Y") : "—" %>
  </td>

  <td>
    <% if svc.present? %>
      <div class="small">
        <strong>
          <%= link_to (svc.service_name.presence || "Service"),
                      fliip_service_path(svc),
                      class: "text-decoration-none" %>
        </strong>
        <% if svc.expire_date.present? %>
          <span class="text-muted"> • ends <%= svc.expire_date.strftime("%d/%m/%Y") %></span>
        <% end %>
      </div>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <td class="align-middle" style="width:18%;">
    <% if svc.present? %>
      <% time_pct = svc.time_progress_percent || 0 %>
      <% paid_pct = svc.paid_progress_percent || 0 %>

      <%= bar_with_label(
            percent: time_pct,
            label:   "#{svc.time_range_label} • #{time_pct}%",
            bg_class: progress_base_color(time_pct)
          ) %>

      <div class="mt-1">
        <%= bar_with_label(
              percent: paid_pct,
              label:   "#{svc.paid_usage_compact_str} #{svc.absences_compact_str} • #{paid_pct}%",
              bg_class: progress_usage_color(paid_pct, time_pct)
            ) %>
      </div>
    <% else %>
      <span class="text-muted small">—</span>
    <% end %>
  </td>
</tr>
