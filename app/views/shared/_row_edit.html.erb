<% s = session %>

<tr data-controller="session-row" data-session-row-id-value="<%= s.id %>">
  <%# 1) Optional bulk checkbox slot stays blank to keep columns aligned %>
  <% if local_assigns[:show_bulk_checkbox] %>
    <td></td>
  <% end %>

  <%# 2) Sequence badge (readonly in edit) %>
  <td class="text-center align-middle">
    <% if s.sequence_label.present? %>
      <span class="badge <%= s.presence_badge_variant %>"><%= s.sequence_label %></span>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 3) Date · Presence (editable) %>
  <td class="small align-middle">
    <%= form_with model: s, url: session_path(s), method: :patch,
                  data: { action: "submit->session-row#submit" }, local: true do |f| %>
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          <%= label_tag :session_date, "Date", class: "form-label small mb-0" %>
          <%= text_field_tag "session[date]",
                             s.occurred_at&.to_date&.strftime("%Y-%m-%d"),
                             class: "form-control form-control-sm", placeholder: "YYYY-MM-DD" %>
        </div>
        <div class="col-auto">
          <%= label_tag :session_time, "Time", class: "form-label small mb-0" %>
          <%= text_field_tag "session[time]",
                             s.occurred_at&.strftime("%H:%M"),
                             class: "form-control form-control-sm", placeholder: "HH:MM" %>
        </div>
        <div class="col-auto">
          <%= label_tag :session_present, "Present", class: "form-label small mb-0 d-block" %>
          <div class="form-check mt-1">
            <%= check_box_tag "session[present]", "1", s.present?, class: "form-check-input", id: "session_present_#{s.id}" %>
            <%= label_tag "session_present_#{s.id}", "Yes", class: "form-check-label small" %>
          </div>
        </div>
        <div class="col-auto">
          <%= label_tag :half_hour, "Duration", class: "form-label small mb-0 d-block" %>
          <div class="form-check mt-1">
            <%= check_box_tag "half_hour", "1", (s.duration.to_f == 0.5), class: "form-check-input", id: "half_hour_#{s.id}" %>
            <%= label_tag "half_hour_#{s.id}", "30 min (unchecked = 60)", class: "form-check-label small" %>
          </div>
        </div>
      </div>

      <div class="mt-2">
        <%= label_tag :session_note, "Note", class: "form-label small mb-1" %>
        <%= text_area_tag "session[note]", s.note, rows: 2, class: "form-control form-control-sm" %>
      </div>

      <%# Actions: Cancel / Save %>
      <div class="mt-2 d-flex justify-content-end gap-2">
        <a href="<%= row_session_path(s) %>" class="btn btn-sm btn-outline-secondary" data-action="session-row#cancel">Cancel</a>
        <button class="btn btn-sm btn-primary" type="submit">Save</button>
      </div>
    <% end %>
  </td>

  <%# 4) Client (readonly) %>
  <td class="align-middle">
    <% if s.fliip_user %>
      <div class="text-truncate"><%= link_to s.fliip_user.full_name, fliip_user_path(s.fliip_user), class: "text-decoration-none" %></div>
      <div class="text-muted small text-truncate">FliipUserID: <%= s.fliip_user.id %> • RemoteID: <%= s.fliip_user.remote_id %></div>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 5) Service (readonly) %>
  <td class="align-middle">
    <% if (svc = s.fliip_service) %>
      <div class="text-truncate"><%= link_to (svc.service_name.presence || "Service ##{svc.id}"), fliip_service_path(svc), class: "text-decoration-none" %></div>
      <div class="text-muted small text-truncate">Svc#: <%= svc.id %> • Purch#: <%= svc.remote_purchase_id %></div>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 6) Employee (readonly) %>
  <td class="text-nowrap align-middle text-center">
    <% if s.user %>
      <%= link_to s.user.full_name, user_path(s.user), class: "text-decoration-none" %>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 7) Actions (blank in edit; we render controls inside the form) %>
  <td class="text-end align-middle text-nowrap"></td>
</tr>
