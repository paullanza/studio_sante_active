<% svc = service %>
<% show_header = local_assigns.fetch(:header, true) %>

<% paid_used  = svc.paid_used_total %>
<% paid_incl  = svc.service_definition&.paid_sessions %>
<% paid_bonus = svc.bonus_sessions_total %>
<% paid_pct   = svc.paid_progress_percent || 0 %>
<% free_used  = svc.free_used_total %>
<% free_incl  = svc.service_definition&.free_sessions %>
<% time_pct   = svc_time_progress_percent(svc) %>

<% time_bg, time_text = progress_color_classes(time_pct) %>
<% paid_bg, paid_text = progress_color_classes(paid_pct) %>

<% if show_header %>
  <div class="small mb-1">
    <strong><%= link_to(svc.service_name.presence || "Service", fliip_service_path(svc)) %></strong>
    <% if svc.expire_date.present? %>
      <span class="text-muted"> • <%= (time_pct == 100) ? "ended" : "ends" %> <%= svc.expire_date.strftime("%d/%m/%Y") %></span>
    <% end %>
  </div>
<% end %>

<!-- Time progress -->
<div class="mb-2">
  <div class="d-flex justify-content-between small">
    <span>Time</span>
    <span><%= svc_time_range_label(svc) %> • <%= time_pct %>%</span>
  </div>
  <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= time_pct %>">
    <div class="progress-bar <%= time_bg %> <%= time_text %>" style="width:<%= time_pct %>%"></div>
  </div>
</div>

<!-- Sessions (paid bar) + free usage bracket -->
<div>
  <div class="d-flex justify-content-between small">
    <span>Sessions</span>
    <span>
      <%= "%.1f" % paid_used %>/<%= paid_incl.nil? ? "—" : paid_incl %> sessions
      <% if paid_bonus.to_f.nonzero? %>
        <span class="text-muted">( +<%= "%.1f" % paid_bonus %> bonus )</span>
      <% end %>
      • <%= paid_pct %>%
      <span class="ms-2 text-muted">[<%= "%.1f" % free_used %>/<%= free_incl.nil? ? "—" : free_incl %> absences]</span>
    </span>
  </div>
  <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= paid_pct %>">
    <div class="progress-bar <%= paid_bg %> <%= paid_text %>" style="width:<%= paid_pct %>%"></div>
  </div>
</div>
