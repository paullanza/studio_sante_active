<%# Expects: svc %>

<%# --- precompute (model does the heavy lifting) --- %>
<% time_pct = svc.time_progress_percent || 0 %>
<% paid_pct = svc.paid_progress_percent || 0 %>

<% badge_class =
     case svc.purchase_status
     when "A" then "bg-success"
     when "P" then "bg-info text-dark"
     when "S" then "bg-warning text-dark"
     when "C" then "bg-danger"
     else           "bg-secondary"
     end %>

<tr>
  <%# 1) Client (name + IDs) %>
  <td class="text-nowrap align-middle">
    <% if svc.fliip_user %>
      <%= link_to svc.fliip_user.full_name, fliip_user_path(svc.fliip_user), class: "text-decoration-none" %>
      <div class="text-muted small">
        UserID: <%= svc.fliip_user.id %> • RemoteID: <%= svc.fliip_user.remote_id %>
      </div>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 2) Status %>
  <td class="text-nowrap align-middle" style="width:1%;">
    <span class="badge <%= badge_class %>"><%= svc.status_name %></span>
  </td>

  <%# 3) Start %>
  <td class="text-nowrap align-middle" style="width:1%;"><%= svc.start_date&.strftime("%d/%m/%Y") || "—" %></td>

  <%# 4) Expire %>
  <td class="text-nowrap align-middle" style="width:1%;"><%= svc.expire_date&.strftime("%d/%m/%Y") || "—" %></td>

  <%# 5) Purchased %>
  <td class="text-nowrap align-middle" style="width:1%;"><%= svc.purchase_date&.strftime("%d/%m/%Y") || "—" %></td>

  <%# 6) Stopped %>
  <td class="text-nowrap align-middle" style="width:1%;"><%= svc.stop_date&.strftime("%d/%m/%Y") || "—" %></td>

  <%# 7) Cancelled %>
  <td class="text-nowrap align-middle" style="width:1%;"><%= svc.cancel_date&.strftime("%d/%m/%Y") || "—" %></td>

  <%# 8) Service (name + compact IDs) %>
  <td class="text-nowrap align-middle">
    <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                fliip_service_path(svc),
                class: "text-decoration-none" %>
    <div class="text-muted small">
      Svc#: <%= svc.id %> • Purch#: <%= svc.remote_purchase_id || "—" %> • DefID: <%= svc.service_definition&.service_id || svc.service_id || "—" %>
    </div>
  </td>

  <%# 9) Duration %>
  <td class="text-nowrap align-middle" style="width:1%;"><%= svc.duration.presence || "—" %></td>

  <%# 10) Progress (stacked bars like Session Row) %>
  <td class="align-middle" style="width:18%;">
    <%= bar_with_label(
          percent: time_pct,
          label:   "#{svc.time_range_label} • #{time_pct}%",
          bg_class: progress_base_color(time_pct)
        ) %>

    <div class="mt-1">
      <%= bar_with_label(
            percent: paid_pct,
            label:   "#{svc.paid_usage_compact_str} #{svc.absences_compact_str} • #{paid_pct}%",
            bg_class: progress_usage_color(paid_pct, time_pct)
          ) %>
    </div>
  </td>
</tr>
