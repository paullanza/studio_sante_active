<%# Expects: svc %>

<%# --- precompute (model does the heavy lifting) --- %>
<% time_pct = svc.time_progress_percent || 0 %>
<% paid_pct = svc.paid_progress_percent || 0 %>

<tr>
  <%# 1) Client (name + IDs) %>
  <td class="align-middle">
    <% if svc.fliip_user %>
      <%= link_to svc.fliip_user.full_name,
                  fliip_user_path(svc.fliip_user),
                  class: "text-decoration-none",
                  data: { turbo_frame: "_top" } %>
      <div class="text-muted small">
        UserID: <%= svc.fliip_user.id %> • RemoteID: <%= svc.fliip_user.remote_id %>
      </div>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 2) Service (name + status badge + duration + compact IDs) %>
  <td class="align-middle">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <span class="badge <%= purchase_status_badge_class(svc.purchase_status) %>"><%= svc.status_name %></span>
      <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                  fliip_service_path(svc),
                  class: "text-decoration-none",
                  data: { turbo_frame: "_top" } %>
    </div>
    <div class="text-muted small">
      Svc#: <%= svc.id %> • Purch#: <%= svc.remote_purchase_id || "—" %> Duration: <%= svc.duration.presence || "—" %>
    </div>
  </td>

  <%# 3) Start (with Purchased underneath if present) %>
  <td class="text-nowrap align-middle" style="width:1%;">
    <div><%= svc.start_date&.strftime("%d/%m/%Y") || "—" %></div>
    <% if svc.purchase_date.present? %>
      <div class="text-muted small">Purchased: <%= svc.purchase_date.strftime("%d/%m/%Y") %></div>
    <% end %>
  </td>

  <%# 4) Expire (with Stopped underneath if present) %>
  <td class="text-nowrap align-middle" style="width:1%;">
    <div><%= svc.expire_date&.strftime("%d/%m/%Y") || "—" %></div>
    <% if svc.stop_date.present? %>
      <div class="text-muted small">Stopped: <%= svc.stop_date.strftime("%d/%m/%Y") %></div>
    <% end %>
  </td>

  <%# 5) Progress (stacked bars) %>
  <td class="align-middle" style="min-width:220px;">
    <%= bar_with_label(
          percent: time_pct,
          label:   "#{svc.time_range_label} • #{time_pct}%",
          bg_class: progress_base_color(time_pct)
        ) %>

    <div class="mt-1">
      <%= bar_with_label(
            percent: paid_pct,
            label:   "#{svc.paid_usage_compact_str} #{svc.absences_compact_str} • #{paid_pct}%",
            bg_class: progress_usage_color(paid_pct, time_pct)
          ) %>
    </div>
  </td>
</tr>
