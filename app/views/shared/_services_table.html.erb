<% fmt_date = ->(d) { d.present? ? d.strftime("%d/%m/%Y") : "—" } %>
<% fmt_num  = ->(n) { ('%.1f' % n.to_f) } %>

<div class="table-responsive">
  <table class="table table-hover align-middle compact-bars">
    <thead class="table-light">
      <tr>
        <th class="text-nowrap">Client</th>
        <th class="text-nowrap" style="width:1%;">IDs</th>
        <th class="text-nowrap" style="width:1%;">Status</th>
        <th class="text-nowrap" style="width:1%;">Start</th>
        <th class="text-nowrap" style="width:1%;">Expire</th>
        <th class="text-nowrap" style="width:1%;">Purchased</th>
        <th class="text-nowrap" style="width:1%;">Stopped</th>
        <th class="text-nowrap" style="width:1%;">Cancelled</th>
        <th class="text-nowrap">Service</th>
        <th class="text-nowrap" style="width:1%;">Duration</th>
      </tr>
    </thead>

    <tbody>
      <% if services.any? %>
        <% services.each do |svc| %>
          <%# --- precompute numbers (model does the heavy lifting) --- %>
          <% paid_used   = svc.paid_used_total %>
          <% paid_incl   = svc.service_definition&.paid_sessions %>
          <% bonus_total = svc.bonus_sessions_total %>
          <% paid_allow  = paid_incl.to_f + bonus_total.to_f %>
          <% paid_pct    = svc.paid_progress_percent || 0 %>

          <% free_used   = svc.free_used_total %>
          <% free_incl   = svc.service_definition&.free_sessions %>

          <% time_pct   = respond_to?(:svc_time_progress_percent) ? svc_time_progress_percent(svc) : 0 %>
          <% time_label = respond_to?(:svc_time_range_label)     ? svc_time_range_label(svc)     : "—" %>

          <% if respond_to?(:progress_color_classes)
               time_bg, time_text = progress_color_classes(time_pct)
               paid_bg, paid_text = progress_color_classes(paid_pct)
             else
               time_bg = "bg-info";    time_text = ""
               paid_bg = "bg-success"; paid_text = ""
             end %>

          <% badge_class =
               case svc.purchase_status
               when "A" then "bg-success"
               when "P" then "bg-info text-dark"
               when "S" then "bg-warning text-dark"
               when "C" then "bg-danger"
               else           "bg-secondary"
               end %>

          <!-- ROW 1: textual data -->
          <tr>
            <td class="text-nowrap">
              <% if svc.fliip_user %>
                <%= link_to svc.fliip_user.full_name, fliip_user_path(svc.fliip_user), class: "text-decoration-none" %>
              <% else %>
                <span class="text-muted">—</span>
              <% end %>
            </td>

            <td class="small text-nowrap" style="width:1%;">
              <div class="font-monospace">
                Svc#: <%= link_to svc.id, fliip_service_path(svc), class: "text-decoration-none" %><br>
                Purch#: <%= svc.remote_purchase_id || "—" %><br>
                DefID:
                <% if svc.service_definition %>
                  <% if current_user.admin? || current_user.super_admin? %>
                    <%= link_to svc.service_id,
                                admin_service_path(svc.service_definition),
                                class: "text-decoration-none" %>
                  <% else %>
                    <span class="text-muted"><%= svc.service_id %></span>
                  <% end %>
                <% else %>
                  <span class="text-muted"><%= svc.service_id || "—" %></span>
                <% end %>
              </div>
            </td>

            <td class="text-nowrap" style="width:1%;">
              <span class="badge <%= badge_class %>"><%= svc.status_name %></span>
            </td>

            <td class="text-nowrap" style="width:1%;"><%= fmt_date.call(svc.start_date) %></td>
            <td class="text-nowrap" style="width:1%;"><%= fmt_date.call(svc.expire_date) %></td>
            <td class="text-nowrap" style="width:1%;"><%= fmt_date.call(svc.purchase_date) %></td>
            <td class="text-nowrap" style="width:1%;"><%= fmt_date.call(svc.stop_date) %></td>
            <td class="text-nowrap" style="width:1%;"><%= fmt_date.call(svc.cancel_date) %></td>

            <td class="text-nowrap">
              <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                          fliip_service_path(svc),
                          class: "text-decoration-none" %>
            </td>

            <td class="text-nowrap" style="width:1%;"><%= svc.duration.presence || "—" %></td>
          </tr>

          <!-- ROW 2: progress bars (compact, side-by-side) -->
          <tr class="align-middle bar-row">
          <%# Left half: Time %>
          <td colspan="5">
            <% time_pct = svc.time_progress_percent || 0 %>
            <%= bar_with_label(
                  percent: time_pct,
                  label:   "#{svc.time_range_label} • #{time_pct}%"
                ) %>
          </td>

          <%# Right half: Sessions %>
          <td colspan="6">
            <% paid_pct = svc.paid_progress_percent || 0 %>
            <%= bar_with_label(
                  percent: paid_pct,
                  label:   "#{svc.paid_usage_compact_str} #{svc.absences_compact_str} • #{paid_pct}%"
                ) %>
          </td>
        </tr>
        <% end %>
      <% else %>
        <tr>
          <td colspan="11" class="text-muted">No services to display.</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
