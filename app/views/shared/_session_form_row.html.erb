<!-- Inline edit row for a session, swapped into the table via Turbo.
     Locals:
       - session: required
       - show_bulk_checkbox: optional (bool)
-->
<% s = local_assigns[:session] || @session %>
<% raise "session is required" unless s %>
<% svc = s.fliip_service %>
<% can_reassign = current_user.admin? || current_user.super_admin? %>

<turbo-frame id="<%= dom_id(s) %>">
  <%= form_with model: s,
                url: session_path(s),
                method: :patch,
                data: { turbo_frame: dom_id(s) },
                class: "m-0 p-0" do |f| %>

    <tr>
      <%# Keep column alignment with optional bulk checkbox column %>
      <% if local_assigns[:show_bulk_checkbox] %>
        <td class="text-center" style="width:36px;">
          <!-- editing: no bulk checkbox -->
        </td>
      <% end %>

      <!-- Date & Time -->
      <td class="text-nowrap small" style="width:1%;">
        <div class="d-flex flex-column gap-1">
          <div class="d-flex gap-2 align-items-center">
            <%= f.date_field :date,
                  class: "form-control form-control-sm",
                  value: s.date&.strftime("%Y-%m-%d") %>
            <%= f.time_field :time,
                  class: "form-control form-control-sm",
                  value: s.time&.strftime("%H:%M") %>
          </div>
          <div class="text-muted">
            <small>(créé : <%= s.created_at.strftime("%d/%m/%Y %H:%M") %>)</small>
          </div>
        </div>
      </td>

      <!-- Client (read-only) -->
      <td class="text-nowrap">
        <% if s.fliip_user %>
          <%= link_to s.fliip_user.full_name,
                      fliip_user_path(s.fliip_user),
                      class: "text-decoration-none" %>
        <% else %>
          <span class="text-muted">—</span>
        <% end %>
      </td>

      <!-- IDs (read-only) -->
      <td class="small text-nowrap" style="width:1%;">
        <div class="font-monospace">
          Sess#: <%= s.id %><br>
          Svc#:
          <% if svc %>
            <%= link_to svc.id, fliip_service_path(svc), class: "text-decoration-none" %>
          <% else %>
            <span class="text-muted">—</span>
          <% end %><br>
          Purch#: <%= svc&.remote_purchase_id || "—" %><br>
          DefID:
          <% if svc&.service_definition %>
            <% if current_user.admin? || current_user.super_admin? %>
              <%= link_to svc.service_definition.service_id,
                          admin_service_path(svc.service_definition),
                          class: "text-decoration-none" %>
            <% else %>
              <span class="text-muted"><%= svc.service_definition.service_id %></span>
            <% end %>
          <% else %>
            <span class="text-muted"><%= svc&.service_id || "—" %></span>
          <% end %>
        </div>
      </td>

      <!-- Service (read-only) -->
      <td class="text-nowrap">
        <% if svc %>
          <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                      fliip_service_path(svc),
                      class: "text-decoration-none" %>
        <% else %>
          <span class="text-muted">—</span>
        <% end %>
      </td>

      <!-- Editable fields -->
      <td class="align-middle" style="width:14%;">
        <div class="d-flex flex-column gap-2">
          <div class="form-check form-switch">
            <%= f.check_box :present, class: "form-check-input", checked: s.present? %>
            <label class="form-check-label">Présent</label>
          </div>

          <div class="form-check">
            <%= check_box_tag :half_hour, "1", s.duration.to_f == 0.5,
                              class: "form-check-input",
                              id: "half_hour_#{s.id}" %>
            <label class="form-check-label" for="half_hour_<%= s.id %>">Durée 30 minutes</label>
          </div>

          <%= f.text_field :note,
                class: "form-control form-control-sm",
                placeholder: "Note (optionnel)",
                value: s.note %>

          <% if can_reassign %>
            <div>
              <%= f.collection_select :user_id,
                    User.active.order(:last_name, :first_name),
                    :id, :full_name,
                    { include_blank: false },
                    { class: "form-select form-select-sm" } %>
              <small class="text-muted">Employé·e responsable</small>
            </div>
          <% end %>
        </div>
      </td>

      <!-- Employee (read-only for non-admins) -->
      <td class="text-nowrap">
        <% if can_reassign %>
          <!-- Shown/changed above -->
          —
        <% else %>
          <%= s.user&.full_name || "—" %>
        <% end %>
      </td>

      <!-- Actions -->
      <td class="text-end" style="width:1%;">
        <div class="d-flex justify-content-end gap-2">
          <%= f.submit "Save", class: "btn btn-sm btn-primary" %>
          <%= link_to "Cancel",
                      session_path(s),
                      data: { turbo_frame: dom_id(s) },
                      class: "btn btn-sm btn-secondary" %>
        </div>
      </td>
    </tr>

    <%# Optional: show note row while editing? Usually omit to keep UI compact. %>
  <% end %>
</turbo-frame>
