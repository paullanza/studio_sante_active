<% s   = session %>
<% svc = s.fliip_service %>

<tr data-controller="session-row"
    data-session-row-id-value="<%= s.id %>"
    data-session-row-show-bulk-value="<%= local_assigns[:show_bulk_checkbox] %>">

  <%# 1) Optional bulk checkbox %>
  <% if local_assigns[:show_bulk_checkbox] %>
    <td class="text-center align-middle">
      <%= check_box_tag "session_ids[]", s.id, false,
            class: "form-check-input m-0",
            data: { select_all_target: "checkboxItem" } %>
    </td>
  <% end %>

  <%# 2) Session number (badge) %>
  <td class="text-center align-middle">
    <% if s.sequence_label.present? %>
      <span class="badge <%= s.presence_badge_variant %>"><%= s.sequence_label %></span>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 3) Date · Presence (wider via table header w-50) %>
  <td class="small align-middle">
    <div class="d-flex flex-column">
      <div class="d-flex align-items-center gap-2">
        <strong><%= s.date_time_label %></strong>
        <span class="badge <%= s.presence_badge_variant %>"><%= s.presence_with_duration_label %></span>
      </div>
      <div class="text-muted"><small><%= s.created_at_label %></small>
            <% if s.confirmed? && s.confirmed_at.present? %>
              <small>| Confirmé·e : <%= s.confirmed_at.strftime('%d/%m/%Y %H:%M') %></small>
            <% end %>
      </div>
    </div>
  </td>

  <%# 4) Client (thinner; truncated) %>
  <td class="align-middle">
    <% if s.fliip_user %>
      <div class="text-truncate">
        <%= link_to s.fliip_user.full_name, fliip_user_path(s.fliip_user), class: "text-decoration-none" %>
      </div>
      <div class="text-muted small text-truncate">
        FliipUserID: <%= s.fliip_user.id %> • RemoteID: <%= s.fliip_user.remote_id %>
      </div>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 5) Service (thinner; truncated) %>
  <td class="align-middle">
    <% if svc %>
      <div class="text-truncate">
        <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                    fliip_service_path(svc),
                    class: "text-decoration-none" %>
      </div>
      <div class="text-muted small text-truncate">
        Serv#: <%= svc.id %> • Achat#: <%= svc.remote_purchase_id %> • DefID: <%= (svc.service_definition&.service_id || svc.service_id) %>
      </div>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 6) Employee (linked); show "created by" if different) %>
  <td class="text-nowrap align-middle text-center">
    <% if s.user %>
      <%= link_to s.user.full_name, user_path(s.user), class: "text-decoration-none" %>
      <% if s.created_by_id.present? && s.created_by_id != s.user_id %>
        <div class="small text-muted">créé·e par <%= s.created_by&.full_name || "—" %></div>
      <% end %>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <%# 7) Actions (right-aligned) %>
  <td class="text-end align-middle text-nowrap">
    <% if s.modifiable_by?(current_user) %>
      <a href="<%= edit_session_path(s) %>" class="btn btn-sm btn-outline-secondary me-1" data-action="session-row#edit">Modifier</a>
      <%= link_to "Supprimer",
                  session_path(s),
                  data: { turbo_method: :delete, turbo_confirm: "Supprimer cette séance?" },
                  class: "btn btn-sm btn-outline-danger" %>
    <% end %>
  </td>
</tr>

<% if s.note.present? %>
  <tr class="note-row" id="<%= dom_id(s, :note) %>">
    <td colspan="<%= (local_assigns[:show_bulk_checkbox] ? 7 : 6) %>" class="py-1">
      <div class="small text-muted">
        <strong>Note :</strong>
        <span><%= s.note %></span>
      </div>
    </td>
  </tr>
<% end %>
