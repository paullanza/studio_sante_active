<%# Renders one session display row (and an optional note row).
    Locals:
      - session: required
      - show_bulk_checkbox: optional (bool)
%>

<% s   = session %>
<% svc = s.fliip_service %>

<%# Progress helpers with fallbacks %>
<% paid_pct   = svc&.try(:paid_progress_percent).to_i rescue 0 %>
<% time_pct   = respond_to?(:svc_time_progress_percent) ? svc_time_progress_percent(svc) : 0 %>
<% time_label = respond_to?(:svc_time_range_label)     ? svc_time_range_label(svc)     : "—" %>

<% paid_used   = svc&.try(:paid_used_total).to_f %>
<% paid_incl   = svc&.service_definition&.paid_sessions %>
<% bonus_total = svc&.try(:bonus_sessions_total).to_f %>
<% paid_allow  = paid_incl.to_f + bonus_total.to_f %>

<% can_modify = current_user.admin? || current_user.super_admin? || (s.user_id == current_user.id && !s.confirmed?) %>

<tr
  data-employee-id="<%= s.user_id %>"
  data-date="<%= s.date&.iso8601 %>"
  data-created-at-epoch="<%= s.created_at.to_i %>"
  data-present="<%= s.present? %>"
  data-session-type="<%= s.session_type %>">

  <% if local_assigns[:show_bulk_checkbox] %>
    <td class="text-center" style="width:36px;">
      <%= check_box_tag "session_ids[]", s.id, false,
                        class: "form-check-input",
                        data: { select_all_target: "checkboxItem" } %>
    </td>
  <% end %>

  <!-- Date & Time -->
  <td class="text-nowrap small" style="width:1%;">
    <div><strong><%= [s.date&.strftime("%d/%m/%Y"), s.time&.strftime("%H:%M")].compact.join(" ") %></strong></div>
    <div class="text-muted"><small>(créé : <%= s.created_at.strftime("%d/%m/%Y %H:%M") %>)</small></div>
  </td>

  <!-- Client -->
  <td class="text-nowrap">
    <% if s.fliip_user %>
      <%= link_to s.fliip_user.full_name, fliip_user_path(s.fliip_user), class: "text-decoration-none" %>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <!-- IDs -->
  <td class="small text-nowrap" style="width:1%;">
    <div class="font-monospace">
      Sess#: <%= s.id %><br>
      Svc#:
      <% if svc %>
        <%= link_to svc.id, fliip_service_path(svc), class: "text-decoration-none" %>
      <% else %>
        <span class="text-muted">—</span>
      <% end %><br>
      Purch#: <%= svc&.remote_purchase_id || "—" %><br>
      DefID:
      <% if svc&.service_definition %>
        <% if current_user.admin? || current_user.super_admin? %>
          <%= link_to svc.service_definition.service_id,
                      admin_service_path(svc.service_definition),
                      class: "text-decoration-none" %>
        <% else %>
          <span class="text-muted"><%= svc.service_definition.service_id %></span>
        <% end %>
      <% else %>
        <span class="text-muted"><%= svc&.service_id || "—" %></span>
      <% end %>
    </div>
  </td>

  <!-- Service -->
  <td class="text-nowrap">
    <% if svc %>
      <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                  fliip_service_path(svc),
                  class: "text-decoration-none" %>
    <% else %>
      <span class="text-muted">—</span>
    <% end %>
  </td>

  <!-- Progress -->
  <td class="align-middle" style="width:14%;">
    <div class="d-flex flex-column gap-1">
      <div class="d-flex justify-content-between small text-muted">
        <span><%= time_label %></span>
        <span><%= time_pct %>%</span>
      </div>
      <div class="progress progress-ultrathin" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= time_pct %>">
        <div class="progress-bar bg-info" style="width:<%= time_pct %>%"></div>
      </div>

      <div class="d-flex justify-content-between small text-muted">
        <span>
          <%= "#{format('%.1f', paid_used)}/#{paid_allow.positive? ? format('%.1f', paid_allow) : '—'}" %>
          (base: <%= paid_incl.nil? ? "—" : paid_incl %>, bonus: <%= format('%.1f', bonus_total) %>)
        </span>
        <span><%= paid_pct %>%</span>
      </div>
      <div class="progress progress-ultrathin" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= paid_pct %>">
        <div class="progress-bar bg-success" style="width:<%= paid_pct %>%"></div>
      </div>
    </div>
  </td>

  <!-- Presence -->
  <td class="text-nowrap">
    <span class="badge bg-secondary"><%= s.presence_label %></span>
  </td>

  <!-- Employee -->
  <td class="text-nowrap"><%= s.user&.full_name || "—" %></td>

  <!-- Actions -->
  <td class="text-end" style="width:1%;">
  </td>
</tr>

<% if s.note.present? %>
  <tr class="note-row" id="<%= dom_id(s, :note) %>">
    <td colspan="<%= (local_assigns[:show_bulk_checkbox] ? 8 : 7) %>" class="py-1">
      <div class="small text-muted">
        <strong>Note :</strong>
        <span><%= s.note %></span>
      </div>
    </td>
  </tr>
<% end %>
