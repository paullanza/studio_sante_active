<%# Locals:
#   sessions: REQUIRED
#   show_bulk_checkbox: default false
#   scope_name: e.g., :unconfirmed (not used for logic yet)
#   compact: default true
%>

<div class="table-responsive" data-controller="select-all">
  <table class="table table-striped table-bordered align-middle compact-bars">
    <thead class="table-light">
      <tr>
        <% if local_assigns[:show_bulk_checkbox] %>
          <th class="text-center" style="width:36px;">
            <input type="checkbox"
                   data-action="select-all#toggleAll"
                   data-select-all-target="checkbox">
          </th>
        <% end %>
        <th class="text-nowrap" style="width:1%;">Date &amp; Heure</th>
        <th class="text-nowrap">Client</th>
        <th class="text-nowrap" style="width:1%;">IDs</th>
        <th class="text-nowrap">Service</th>
        <th class="text-nowrap" style="width:14%;">Progression</th>
        <th class="text-nowrap" style="width:1%;">Employé·e</th>
        <th class="text-end"   style="width:1%;">Actions</th>
      </tr>
    </thead>

    <tbody>
      <% if sessions.any? %>
        <% sessions.each do |s| %>
          <% svc = s.fliip_service %>
          <% # paid progress from service %>
          <% paid_pct = svc&.try(:paid_progress_percent).to_i rescue 0 %>

          <% # time progress helpers if you have them; fallback 0 %>
          <% time_pct   = respond_to?(:svc_time_progress_percent) ? svc_time_progress_percent(svc) : 0 %>
          <% time_label = respond_to?(:svc_time_range_label)     ? svc_time_range_label(svc)     : "—" %>

          <% paid_used   = svc&.try(:paid_used_total).to_f %>
          <% paid_incl   = svc&.service_definition&.paid_sessions %>
          <% bonus_total = svc&.try(:bonus_sessions_total).to_f %>
          <% paid_allow  = paid_incl.to_f + bonus_total.to_f %>

          <tr
            data-employee-id="<%= s.user_id %>"
            data-date="<%= s.date&.iso8601 %>"
            data-created-at-epoch="<%= s.created_at.to_i %>"
            data-present="<%= s.present? %>"
            data-session-type="<%= s.session_type %>">

            <% if local_assigns[:show_bulk_checkbox] %>
              <td class="text-center">
                <%= check_box_tag "session_ids[]", s.id, false,
                                  class: "form-check-input",
                                  data: { select_all_target: "checkboxItem" } %>
              </td>
            <% end %>

            <!-- Date & Time (created_at underneath in brackets) -->
            <td class="text-nowrap small">
              <div><strong><%= [s.date&.strftime("%d/%m/%Y"), s.time&.strftime("%H:%M")].compact.join(" ") %></strong></div>
              <div class="text-muted"><small>(créé : <%= s.created_at.strftime("%d/%m/%Y %H:%M") %>)</small></div>
            </td>

            <!-- Client (link) -->
            <td class="text-nowrap">
              <% if s.fliip_user %>
                <%= link_to s.fliip_user.full_name,
                            fliip_user_path(s.fliip_user),
                            class: "text-decoration-none" %>
              <% else %>
                <span class="text-muted">—</span>
              <% end %>
            </td>

            <!-- IDs (same content/links pattern as inspiration) -->
            <td class="small text-nowrap" style="width:1%;">
              <div class="font-monospace">
                Sess#: <%= s.id %><br>
                Svc#:
                <% if svc %>
                  <%= link_to svc.id, fliip_service_path(svc), class: "text-decoration-none" %>
                <% else %>
                  <span class="text-muted">—</span>
                <% end %><br>
                Purch#: <%= svc&.remote_purchase_id || "—" %><br>
                DefID:
                <% if svc&.service_definition %>
                  <% if current_user.admin? || current_user.super_admin? %>
                    <%= link_to svc.service_definition.service_id,
                                admin_service_path(svc.service_definition),
                                class: "text-decoration-none" %>
                  <% else %>
                    <span class="text-muted"><%= svc.service_definition.service_id %></span>
                  <% end %>
                <% else %>
                  <span class="text-muted"><%= svc&.service_id || "—" %></span>
                <% end %>
              </div>
            </td>

            <!-- Service (link) -->
            <td class="text-nowrap">
              <% if svc %>
                <%= link_to (svc.service_name.presence || "Service ##{svc.id}"),
                            fliip_service_path(svc),
                            class: "text-decoration-none" %>
              <% else %>
                <span class="text-muted">—</span>
              <% end %>
            </td>

            <!-- Progress (both tiny bars, same labels, very compact) -->
            <td class="align-middle">
              <div class="d-flex flex-column gap-1">
                <!-- Time bar -->
                <div class="d-flex justify-content-between small text-muted">
                  <span><%= time_label %></span>
                  <span><%= time_pct %>%</span>
                </div>
                <div class="progress progress-ultrathin" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= time_pct %>">
                  <div class="progress-bar bg-info" style="width:<%= time_pct %>%"></div>
                </div>

                <!-- Paid progress -->
                <div class="d-flex justify-content-between small text-muted">
                  <span>
                    <%= "#{format('%.1f', paid_used)}/#{paid_allow.positive? ? format('%.1f', paid_allow) : '—'}" %>
                    (base: <%= paid_incl.nil? ? "—" : paid_incl %>, bonus: <%= format('%.1f', bonus_total) %>)
                  </span>
                  <span><%= paid_pct %>%</span>
                </div>
                <div class="progress progress-ultrathin" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= paid_pct %>">
                  <div class="progress-bar bg-success" style="width:<%= paid_pct %>%"></div>
                </div>
              </div>
            </td>

            <!-- Employee -->
            <td class="text-nowrap"><%= s.user&.full_name || "—" %></td>

            <!-- Actions (unconfirmed page: admin sees edit/delete) -->
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-outline-primary" data-action="session-row#edit">Edit</button>
              <button type="button" class="btn btn-sm btn-outline-danger"  data-action="session-row#delete">Delete</button>
            </td>
          </tr>

          <% if s.note.present? %>
            <tr class="note-row">
              <td colspan="<%= (local_assigns[:show_bulk_checkbox] ? 8 : 7) %>" class="py-1">
                <div class="small text-muted">
                  <strong>Note :</strong>
                  <span><%= s.note %></span>
                </div>
              </td>
            </tr>
          <% end %>
        <% end %>
      <% else %>
        <tr>
          <td colspan="<%= local_assigns[:show_bulk_checkbox] ? 8 : 7 %>" class="text-muted">No sessions to display.</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
