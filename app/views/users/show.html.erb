<div class="container mt-4" data-controller="toggle">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="mb-0"><%= @user.full_name %></h1>
    <%= link_to "Back", admin_dashboard_path, class: "btn btn-secondary" %>
  </div>

  <div class="card my-3">
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Email</th>
            <th>Phone</th>
            <th>Birthday</th>
            <th>Role</th>
            <th>Status</th>
            <th style="min-width:260px;">Address</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= @user.email.present? ? mail_to(@user.email) : "—" %></td>
            <td><%= @user.phone.presence || "—" %></td>
            <td><%= @user.birthday&.strftime("%d/%m/%Y") || "—" %></td>
            <td>
              <span class="badge <%= @user.super_admin? ? 'bg-dark' : @user.admin? ? 'bg-primary' : @user.manager? ? 'bg-info text-dark' : 'bg-secondary' %>">
                <%= @user.role.titleize %>
              </span>
            </td>
            <td>
              <span class="badge <%= @user.active? ? 'bg-success' : 'bg-secondary' %>">
                <%= @user.active? ? "Active" : "Inactive" %>
              </span>
            </td>
            <td class="text-truncate" style="max-width: 380px;" title="<%= @user.address.to_s %>">
              <%= @user.address.presence || "—" %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit toggle button (admins only) -->
  <% if current_user.admin? || current_user.super_admin? %>
    <div class="my-3">
      <button type="button" class="btn btn-outline-primary btn-sm" data-action="toggle#toggle">
        Edit details
      </button>
    </div>

    <!-- Hidden edit form -->
    <div class="card mb-3 d-none" data-toggle-target="section">
      <div class="card-body">
        <h5 class="card-title mb-3">Edit User</h5>
        <%= simple_form_for @user, url: user_path(@user), method: :patch do |f| %>
          <div class="row g-3">
            <div class="col-md-6"><%= f.input :first_name %></div>
            <div class="col-md-6"><%= f.input :last_name %></div>
            <div class="col-md-6"><%= f.input :email %></div>
            <div class="col-md-6"><%= f.input :phone %></div>
            <div class="col-md-12"><%= f.input :address %></div>
            <div class="col-md-4">
              <%= f.input :birthday, as: :string,
                    input_html: { type: "date", value: (@user.birthday || Date.today) } %>
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <%= f.button :submit, "Save Changes", class: "btn btn-primary" %>
            <button type="button" class="btn btn-outline-secondary" data-action="toggle#toggle">Cancel</button>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Role / Activation controls (same rules you use on dashboard) -->
  <div class="my-3">
    <% if @user.super_admin? %>
      <span class="text-muted">Super Admin</span>
    <% elsif current_user.super_admin? %>
      <div class="d-flex flex-wrap gap-2">
        <% if @user.admin? %>
          <%= button_to "Make Manager", make_manager_user_path(@user), method: :patch, class: "btn btn-outline-primary btn-sm" %>
        <% elsif @user.manager? %>
          <%= button_to "Make Employee", make_employee_user_path(@user), method: :patch, class: "btn btn-outline-secondary btn-sm" %>
          <%= button_to "Make Admin",    make_admin_user_path(@user),    method: :patch, class: "btn btn-outline-dark btn-sm" %>
        <% else %>
          <%= button_to "Make Manager",  make_manager_user_path(@user),  method: :patch, class: "btn btn-outline-primary btn-sm" %>
        <% end %>

        <%= button_to(
              @user.active? ? "Deactivate" : "Reactivate",
              @user.active? ? deactivate_user_path(@user) : activate_user_path(@user),
              method: :patch,
              class: "btn btn-sm #{ @user.active? ? 'btn-outline-danger' : 'btn-outline-success' }"
        ) %>
      </div>

    <% elsif current_user.admin? %>
      <% if @user.admin? %>
        <span class="text-muted">Admin</span>
      <% elsif @user.manager? %>
        <div class="d-flex flex-wrap gap-2">
          <%= button_to "Make Employee", make_employee_user_path(@user), method: :patch, class: "btn btn-outline-secondary btn-sm" %>
        <%= button_to(
              @user.active? ? "Deactivate" : "Reactivate",
              @user.active? ? deactivate_user_path(@user) : activate_user_path(@user),
              method: :patch,
              class: "btn btn-sm #{ @user.active? ? 'btn-outline-danger' : 'btn-outline-success' }"
        ) %>
        </div>
      <% else %>
        <div class="d-flex flex-wrap gap-2">
          <%= button_to "Make Manager",  make_manager_user_path(@user),  method: :patch, class: "btn btn-outline-primary btn-sm" %>
          <%= button_to(
                @user.active? ? "Deactivate" : "Reactivate",
                @user.active? ? deactivate_user_path(@user) : activate_user_path(@user),
                method: :patch,
                class: "btn btn-sm #{ @user.active? ? 'btn-outline-danger' : 'btn-outline-success' }"
          ) %>
        </div>
      <% end %>
    <% elsif current_user.manager? && @user.employee? %>
      <%= button_to(
            @user.active? ? "Deactivate" : "Reactivate",
            @user.active? ? deactivate_user_path(@user) : activate_user_path(@user),
            method: :patch,
            class: "btn btn-sm #{ @user.active? ? 'btn-outline-danger' : 'btn-outline-success' }"
      ) %>
    <% end %>
  </div>

  <!-- Services this user touched -->
  <div class="mt-4">
    <h2 class="h5 mb-2">Services this user has worked on</h2>
    <%= render "shared/services_table", services: @services_for_user %>
  </div>

  <!-- Unconfirmed sessions (same look as admin page, no checkboxes/actions) -->
  <div class="mt-4">
    <h2 class="h5 mb-2">Unconfirmed Sessions</h2>

    <% if @unconfirmed_sessions.any? %>
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead>
            <tr>
              <th>Client</th>
              <th>Service</th>
              <th>Date</th>
              <th>Time</th>
              <th>Présent</th>
              <th>Note</th>
              <th>Créé par</th>
            </tr>
          </thead>
          <tbody>
            <% @unconfirmed_sessions.each do |s| %>
              <tr>
                <td><%= s.fliip_user&.full_name %></td>
                <td><%= s.fliip_service&.service_name %></td>
                <td><%= s.date&.strftime("%Y-%m-%d") || "—" %></td>
                <td><%= s.time&.strftime("%H:%M") || "—" %></td>
                <td><%= s.present? ? "Oui" : "Non" %></td>
                <td><%= s.note.presence || "–" %></td>
                <td><%= s.user&.full_name || "–" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">No unconfirmed sessions found.</p>
    <% end %>
  </div>
</div>
